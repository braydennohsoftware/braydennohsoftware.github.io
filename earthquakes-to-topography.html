---
layout: default
title:  Earthquakes to Topography
---

<p>
<a href="index.html">Brayden Noh</a>
</p>

<h1>Earthquake Cycles to Topography</h1>

<p>
This simulator models topographic evolution over a planar reverse fault (0&ndash;100 km, 0&ndash;20 km depth) using the stream power equation.
Uplift is partitioned into steady <b>interseismic creeping</b> (shallow fault) and sudden <b>coseismic rupture</b> (deep fault) driven by the accumulated slip deficit. Adjust the cycle time and locking depth to see how earthquake frequency, magnitude, and fault coupling affect terrace formation.
</p>

<style>
  .controls {
    display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;
    padding: 15px 20px; background: #f1f3f5; border-radius: 6px;
  }
  .button-group {
    display: flex; gap: 8px; margin-top: 5px;
  }
  .controls button {
    padding: 8px 16px; border: none; border-radius: 4px;
    background: #3498db; color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s;
  }
  .controls button:hover:not(:disabled) { background: #2980b9; }
  .controls button:disabled { background: #bdc3c7; cursor: not-allowed; }

  .sliders-container {
    display: flex; flex-direction: column; gap: 12px; flex: 1;
  }
  .slider-group { display: flex; align-items: center; gap: 12px; }
  .slider-group label { font-weight: 600; font-size: 14px; color: #2c3e50; min-width: 220px; }
  .slider-group input { flex: 1; cursor: pointer; }
  .slider-val { font-family: monospace; font-size: 14px; font-weight: bold; color: #e74c3c; width: 80px; text-align: right; }

  .info-bar {
    display: flex; gap: 25px; font-size: 14px; color: #555;
    margin-bottom: 15px; font-weight: 500; border-bottom: 1px solid #eee; padding-bottom: 10px;
  }
  .info-bar span strong { color: #2980b9; font-family: monospace; font-size: 15px; }
  .plot-title { font-size: 14px; font-weight: 600; color: #34495e; margin: 15px 0 5px 0; }
  #sim-container canvas { width: 100%; height: auto; display: block; }
</style>

<div class="controls">
  <div class="button-group">
    <button id="btn-play">Play</button>
    <button id="btn-pause" disabled>Pause</button>
    <button id="btn-reset">Reset</button>
  </div>
  <div class="sliders-container">
    <div class="slider-group">
      <label for="sl-interval">Earthquake Cycle (Slip Deficit):</label>
      <input id="sl-interval" type="range" min="0" max="10010" step="10" value="100">
      <div class="slider-val" id="val-interval">100 yr</div>
    </div>
    <div class="slider-group">
      <label for="sl-locked">Locking Depth:</label>
      <input id="sl-locked" type="range" min="100" max="900" step="100" value="500">
      <div class="slider-val" id="val-locked">10 km</div>
    </div>
    <div class="slider-group">
      <label for="sl-speed">Simulation Speed:</label>
      <input id="sl-speed" type="range" min="1" max="200" step="1" value="20">
      <div class="slider-val" id="val-speed">20x</div>
    </div>
  </div>
</div>

<div class="info-bar">
  <span>Time: <strong id="info-time">0</strong> yr</span>
  <span>Earthquakes: <strong id="info-eq">0</strong></span>
  <span>Next EQ in: <strong id="info-next">100</strong> yr</span>
  <span>Max Elevation: <strong id="info-maxz">0.0</strong> m</span>
</div>

<div id="sim-container">
  <div class="plot-title">Topography Evolution</div>
  <canvas id="canvas-topo"></canvas>

  <div class="plot-title">Uplift Rate</div>
  <canvas id="canvas-uplift"></canvas>

  <div class="plot-title">Fault Geometry &amp; Activity</div>
  <canvas id="canvas-fault"></canvas>
</div>

<script>
(function () {
"use strict";

/* ================================================================
   Section 0: Precomputed Data & Constants
   ================================================================ */
// Uplift profiles for different locking depths (n_locked = creeping segments)
// Each profile has: rp (red prefix), rt (red tail), bp (blue prefix), bt (blue tail), fc (fault display cut)
var PROFILES = {};
PROFILES[100] = {rp:[0.2513,0.2668,0.2897,0.3157,0.3453,0.3791,0.4181,0.4631,0.5157,0.5775,0.6506,0.7379,0.8432,0.9713,1.1288,1.3247,1.571,1.8838,2.2847,2.8007,3.4627,4.2967,5.302,6.4115,7.4548,8.1911,8.45,8.2582,7.7919,7.2352,6.7023,6.2404,5.8584,5.5487,5.2991,5.0977,4.9342,4.8006,4.6905,4.5989,4.5222,4.4574,4.4023,4.3551,4.3143,4.2789,4.248,4.2209,4.197,4.1758,4.157,4.1401,4.125,4.1114,4.099,4.0879,4.0778,4.0685,4.0601,4.0523,4.0452,4.0387,4.0326,4.027,4.0219,4.0171,4.0126,4.0084,4.0046,4.0009,3.9976,3.9944,3.9914,3.9886,3.986,3.9835,3.9812,3.9789,3.9769,3.9749,3.973,3.9712,3.9696,3.968,3.9665,3.965,3.9636,3.9623,3.9611,3.9599,3.9588,3.9577,3.9566,3.9557,3.9547,3.9538,3.9529,3.9521,3.9513,3.9505,3.9498,3.9491,3.9484,3.9477,3.9471,3.9465,3.9459,3.9453,3.9448,3.9442,3.9437,3.9432,3.9428,3.9423,3.9419,3.9414,3.941,3.9406,3.9402,3.9399,3.9395,3.9391,3.9388,3.9385,3.9381,3.9378,3.9375,3.9372,3.9369,3.9367,3.9364,3.9361,3.9359,3.9356,3.9354,3.9351,3.9349,3.9347,3.9345,3.9343,3.9341,3.9339,3.9337,3.9335,3.9333,3.9331,3.9329,3.9328,3.9326,3.9324,3.9323,3.9321,3.932,3.9318,3.9317,3.9315,3.9314,3.9312,3.9311,3.931,3.9309,3.9307,3.9306,3.9305,3.9304,3.9303,3.9301,3.93,3.9299,3.9298,3.9297,3.9296,3.9295,3.9294,3.9293,3.9292,3.9291,3.9291,3.929,3.9289,3.9288,3.9287,3.9286,3.9286,3.9285,3.9284,3.9283,3.9283,3.9282,3.9281,3.928,3.928,3.9279,3.9278,3.9278,3.9277,3.9276,3.9276,3.9275,3.9275,3.9274,3.9273,3.9273,3.9272,3.9272,3.9271,3.9271,3.927,3.927,3.9269,3.9269,3.9268,3.9268,3.9267,3.9267,3.9266,3.9266,3.9265,3.9265,3.9265,3.9264,3.9264,3.9263,3.9263,3.9263,3.9262,3.9262,3.9261,3.9261,3.9261,3.926,3.926,3.926,3.9259,3.9259,3.9259,3.9258,3.9258,3.9258,3.9257,3.9257,3.9257,3.9256,3.9256,3.9256,3.9255,3.9255,3.9255,3.9255,3.9254,3.9254],rt:3.9254,bp:[3.671,3.6555,3.6326,3.6066,3.577,3.5432,3.5043,3.4592,3.4066,3.3448,3.2717,3.1844,3.0792,2.9511,2.7935,2.5976,2.3514,2.0385,1.6377,1.1217,0.4597,-0.3744,-1.3797,-2.4892,-3.5325,-4.2688,-4.5277,-4.3359,-3.8696,-3.3129,-2.78,-2.3181,-1.9361,-1.6264,-1.3768,-1.1754,-1.0119,-0.8783,-0.7681,-0.6766,-0.5999,-0.5351,-0.48,-0.4327,-0.392,-0.3566,-0.3257,-0.2986,-0.2747,-0.2535,-0.2346,-0.2178,-0.2026,-0.189,-0.1767,-0.1656,-0.1554,-0.1462,-0.1377,-0.13,-0.1229,-0.1163,-0.1103,-0.1047,-0.0995,-0.0947,-0.0903,-0.0861,-0.0822,-0.0786,-0.0752,-0.0721,-0.0691,-0.0663,-0.0636,-0.0612,-0.0588,-0.0566,-0.0545,-0.0526,-0.0507,-0.0489,-0.0472,-0.0457,-0.0441,-0.0427,-0.0413,-0.04,-0.0388,-0.0376,-0.0364,-0.0354,-0.0343,-0.0333,-0.0324,-0.0315,-0.0306,-0.0298,-0.029,-0.0282,-0.0274,-0.0267,-0.0261,-0.0254,-0.0248,-0.0242,-0.0236,-0.023,-0.0224,-0.0219,-0.0214,-0.0209,-0.0204,-0.02,-0.0195,-0.0191,-0.0187,-0.0183,-0.0179,-0.0175,-0.0172,-0.0168,-0.0165,-0.0161,-0.0158,-0.0155,-0.0152,-0.0149,-0.0146,-0.0143,-0.0141,-0.0138,-0.0136,-0.0133,-0.0131,-0.0128,-0.0126,-0.0124,-0.0122,-0.0119,-0.0117,-0.0115,-0.0113,-0.0112,-0.011,-0.0108,-0.0106,-0.0104,-0.0103,-0.0101,-0.0099,-0.0098,-0.0096,-0.0095,-0.0093,-0.0092,-0.0091,-0.0089,-0.0088,-0.0087,-0.0085,-0.0084,-0.0083,-0.0082,-0.008,-0.0079,-0.0078,-0.0077,-0.0076,-0.0075,-0.0074,-0.0073,-0.0072,-0.0071,-0.007,-0.0069,-0.0068,-0.0067,-0.0066,-0.0066,-0.0065,-0.0064,-0.0063,-0.0062,-0.0062,-0.0061,-0.006,-0.0059,-0.0059,-0.0058,-0.0057,-0.0056,-0.0056,-0.0055,-0.0055,-0.0054,-0.0053,-0.0053,-0.0052,-0.0051,-0.0051,-0.005,-0.005,-0.0049,-0.0049,-0.0048,-0.0048,-0.0047,-0.0047,-0.0046,-0.0046,-0.0045,-0.0045,-0.0044,-0.0044,-0.0043,-0.0043,-0.0042,-0.0042,-0.0041,-0.0041,-0.0041,-0.004,-0.004,-0.0039,-0.0039,-0.0039,-0.0038,-0.0038,-0.0037,-0.0037,-0.0037,-0.0036,-0.0036,-0.0036,-0.0035,-0.0035,-0.0035,-0.0034,-0.0034,-0.0034,-0.0033,-0.0033,-0.0033,-0.0032,-0.0032,-0.0032,-0.0032,-0.0031,-0.0031,-0.0031],bt:-0.0031,fc:10};
PROFILES[200] = {rp:[0.2489,0.2563,0.2668,0.2779,0.2897,0.3023,0.3157,0.33,0.3453,0.3616,0.3791,0.3979,0.4181,0.4398,0.4631,0.4884,0.5157,0.5453,0.5775,0.6125,0.6506,0.6923,0.7379,0.788,0.8432,0.904,0.9713,1.0459,1.1288,1.2213,1.3247,1.4406,1.571,1.7179,1.8838,2.0717,2.2847,2.5264,2.8007,3.1115,3.4627,3.8572,4.2967,4.78,5.302,5.8518,6.4115,6.956,7.4548,7.8758,8.1911,8.3836,8.45,8.4012,8.2582,8.0466,7.7919,7.5159,7.2352,6.9616,6.7023,6.4613,6.2404,6.0397,5.8584,5.6952,5.5487,5.4172,5.2991,5.1931,5.0977,5.0118,4.9342,4.8641,4.8006,4.7429,4.6905,4.6426,4.5989,4.5589,4.5222,4.4885,4.4574,4.4288,4.4023,4.3778,4.3551,4.3339,4.3143,4.296,4.2789,4.263,4.248,4.234,4.2209,4.2086,4.197,4.1861,4.1758,4.1661,4.157,4.1483,4.1401,4.1323,4.125,4.118,4.1114,4.105,4.099,4.0933,4.0879,4.0827,4.0778,4.073,4.0685,4.0642,4.0601,4.0561,4.0523,4.0487,4.0452,4.0419,4.0387,4.0356,4.0326,4.0298,4.027,4.0244,4.0219,4.0194,4.0171,4.0148,4.0126,4.0105,4.0084,4.0065,4.0046,4.0027,4.0009,3.9992,3.9976,3.9959,3.9944,3.9929,3.9914,3.99,3.9886,3.9873,3.986,3.9847,3.9835,3.9823,3.9812,3.98,3.9789,3.9779,3.9769,3.9759,3.9749,3.9739,3.973,3.9721,3.9712,3.9704,3.9696,3.9688,3.968,3.9672,3.9665,3.9657,3.965,3.9643,3.9636,3.963,3.9623,3.9617,3.9611,3.9605,3.9599,3.9593,3.9588,3.9582,3.9577,3.9572,3.9566,3.9561,3.9557,3.9552,3.9547,3.9542,3.9538,3.9534,3.9529,3.9525,3.9521,3.9517,3.9513,3.9509,3.9505,3.9501,3.9498,3.9494,3.9491,3.9487,3.9484,3.948,3.9477,3.9474,3.9471,3.9468,3.9465,3.9462,3.9459,3.9456,3.9453,3.945,3.9448,3.9445,3.9442,3.944,3.9437,3.9435,3.9432,3.943,3.9428,3.9425,3.9423,3.9421,3.9419,3.9416,3.9414,3.9412,3.941,3.9408,3.9406,3.9404,3.9402,3.94,3.9399,3.9397,3.9395,3.9393,3.9391,3.939,3.9388,3.9386,3.9385,3.9383,3.9381,3.938,3.9378],rt:3.9378,bp:[3.6735,3.666,3.6555,3.6444,3.6326,3.62,3.6066,3.5923,3.577,3.5607,3.5432,3.5244,3.5043,3.4826,3.4592,3.4339,3.4066,3.377,3.3448,3.3098,3.2717,3.23,3.1844,3.1343,3.0792,3.0183,2.9511,2.8765,2.7935,2.701,2.5976,2.4817,2.3514,2.2045,2.0385,1.8507,1.6377,1.3959,1.1217,0.8108,0.4597,0.0651,-0.3744,-0.8577,-1.3797,-1.9295,-2.4892,-3.0337,-3.5325,-3.9534,-4.2688,-4.4612,-4.5277,-4.4789,-4.3359,-4.1243,-3.8696,-3.5936,-3.3129,-3.0393,-2.78,-2.539,-2.3181,-2.1174,-1.9361,-1.7729,-1.6264,-1.4949,-1.3768,-1.2707,-1.1754,-1.0894,-1.0119,-0.9418,-0.8783,-0.8206,-0.7681,-0.7203,-0.6766,-0.6366,-0.5999,-0.5662,-0.5351,-0.5065,-0.48,-0.4555,-0.4327,-0.4116,-0.392,-0.3737,-0.3566,-0.3406,-0.3257,-0.3117,-0.2986,-0.2863,-0.2747,-0.2638,-0.2535,-0.2438,-0.2346,-0.226,-0.2178,-0.21,-0.2026,-0.1957,-0.189,-0.1827,-0.1767,-0.171,-0.1656,-0.1604,-0.1554,-0.1507,-0.1462,-0.1419,-0.1377,-0.1338,-0.13,-0.1264,-0.1229,-0.1196,-0.1163,-0.1133,-0.1103,-0.1075,-0.1047,-0.1021,-0.0995,-0.0971,-0.0947,-0.0925,-0.0903,-0.0882,-0.0861,-0.0842,-0.0822,-0.0804,-0.0786,-0.0769,-0.0752,-0.0736,-0.0721,-0.0705,-0.0691,-0.0677,-0.0663,-0.0649,-0.0636,-0.0624,-0.0612,-0.06,-0.0588,-0.0577,-0.0566,-0.0556,-0.0545,-0.0535,-0.0526,-0.0516,-0.0507,-0.0498,-0.0489,-0.0481,-0.0472,-0.0464,-0.0457,-0.0449,-0.0441,-0.0434,-0.0427,-0.042,-0.0413,-0.0407,-0.04,-0.0394,-0.0388,-0.0382,-0.0376,-0.037,-0.0364,-0.0359,-0.0354,-0.0348,-0.0343,-0.0338,-0.0333,-0.0329,-0.0324,-0.0319,-0.0315,-0.031,-0.0306,-0.0302,-0.0298,-0.0294,-0.029,-0.0286,-0.0282,-0.0278,-0.0274,-0.0271,-0.0267,-0.0264,-0.0261,-0.0257,-0.0254,-0.0251,-0.0248,-0.0245,-0.0242,-0.0239,-0.0236,-0.0233,-0.023,-0.0227,-0.0224,-0.0222,-0.0219,-0.0217,-0.0214,-0.0212,-0.0209,-0.0207,-0.0204,-0.0202,-0.02,-0.0198,-0.0195,-0.0193,-0.0191,-0.0189,-0.0187,-0.0185,-0.0183,-0.0181,-0.0179,-0.0177,-0.0175,-0.0173,-0.0172,-0.017,-0.0168,-0.0166,-0.0165,-0.0163,-0.0161,-0.016,-0.0158,-0.0157,-0.0155],bt:-0.0155,fc:20};
PROFILES[300] = {rp:[0.2481,0.253,0.2598,0.2668,0.2741,0.2818,0.2897,0.298,0.3067,0.3157,0.3251,0.335,0.3453,0.3561,0.3673,0.3791,0.3915,0.4044,0.4181,0.4323,0.4474,0.4631,0.4798,0.4973,0.5157,0.5352,0.5558,0.5775,0.6005,0.6248,0.6506,0.678,0.707,0.7379,0.7708,0.8058,0.8432,0.883,0.9257,0.9713,1.0201,1.0725,1.1288,1.1893,1.2545,1.3247,1.4005,1.4824,1.571,1.6669,1.7709,1.8838,2.0064,2.1397,2.2847,2.4424,2.614,2.8007,3.0036,3.2239,3.4627,3.7207,3.9987,4.2967,4.6143,4.9501,5.302,5.6664,6.0383,6.4115,6.778,7.129,7.4548,7.746,7.9937,8.1911,8.3336,8.4195,8.45,8.4292,8.3628,8.2582,8.1231,7.9653,7.7919,7.6091,7.4222,7.2352,7.0515,6.8733,6.7023,6.5395,6.3854,6.2404,6.1044,5.9772,5.8584,5.7477,5.6446,5.5487,5.4594,5.3764,5.2991,5.2272,5.1602,5.0977,5.0394,4.985,4.9342,4.8867,4.8423,4.8006,4.7615,4.7249,4.6905,4.6581,4.6276,4.5989,4.5719,4.5463,4.5222,4.4994,4.4779,4.4574,4.4381,4.4197,4.4023,4.3858,4.37,4.3551,4.3408,4.3272,4.3143,4.302,4.2902,4.2789,4.2682,4.2579,4.248,4.2386,4.2296,4.2209,4.2126,4.2047,4.197,4.1897,4.1826,4.1758,4.1693,4.163,4.157,4.1511,4.1455,4.1401,4.1349,4.1298,4.125,4.1203,4.1157,4.1114,4.1071,4.103,4.099,4.0952,4.0915,4.0879,4.0844,4.081,4.0778,4.0746,4.0715,4.0685,4.0656,4.0628,4.0601,4.0574,4.0548,4.0523,4.0499,4.0475,4.0452,4.043,4.0408,4.0387,4.0366,4.0346,4.0326,4.0307,4.0289,4.027,4.0253,4.0235,4.0219,4.0202,4.0186,4.0171,4.0155,4.0141,4.0126,4.0112,4.0098,4.0084,4.0071,4.0058,4.0046,4.0033,4.0021,4.0009,3.9998,3.9987,3.9976,3.9965,3.9954,3.9944,3.9934,3.9924,3.9914,3.9904,3.9895,3.9886,3.9877,3.9868,3.986,3.9851,3.9843,3.9835,3.9827,3.9819,3.9812,3.9804,3.9797,3.9789,3.9782,3.9775,3.9769,3.9762,3.9755,3.9749,3.9743,3.9736,3.973,3.9724,3.9718,3.9712,3.9707,3.9701,3.9696,3.969,3.9685,3.968,3.9675],rt:3.9675,bp:[3.6743,3.6694,3.6626,3.6555,3.6482,3.6405,3.6326,3.6243,3.6156,3.6066,3.5972,3.5873,3.577,3.5663,3.555,3.5432,3.5308,3.5179,3.5043,3.49,3.475,3.4592,3.4426,3.425,3.4066,3.3871,3.3666,3.3448,3.3218,3.2975,3.2717,3.2443,3.2153,3.1844,3.1515,3.1165,3.0792,3.0393,2.9967,2.9511,2.9022,2.8498,2.7935,2.733,2.6679,2.5976,2.5218,2.44,2.3514,2.2554,2.1514,2.0385,1.9159,1.7826,1.6377,1.4799,1.3083,1.1217,0.9187,0.6984,0.4597,0.2016,-0.0764,-0.3744,-0.6919,-1.0278,-1.3797,-1.7441,-2.116,-2.4892,-2.8557,-3.2067,-3.5325,-3.8236,-4.0714,-4.2688,-4.4112,-4.4971,-4.5277,-4.5068,-4.4405,-4.3359,-4.2008,-4.043,-3.8696,-3.6868,-3.4998,-3.3129,-3.1292,-2.951,-2.78,-2.6172,-2.4631,-2.3181,-2.1821,-2.0548,-1.9361,-1.8254,-1.7223,-1.6264,-1.5371,-1.4541,-1.3768,-1.3048,-1.2378,-1.1754,-1.1171,-1.0627,-1.0119,-0.9644,-0.9199,-0.8783,-0.8392,-0.8026,-0.7681,-0.7358,-0.7053,-0.6766,-0.6496,-0.624,-0.5999,-0.5771,-0.5555,-0.5351,-0.5158,-0.4974,-0.48,-0.4634,-0.4477,-0.4327,-0.4185,-0.4049,-0.392,-0.3796,-0.3679,-0.3566,-0.3458,-0.3356,-0.3257,-0.3163,-0.3073,-0.2986,-0.2903,-0.2823,-0.2747,-0.2673,-0.2603,-0.2535,-0.247,-0.2407,-0.2346,-0.2288,-0.2232,-0.2178,-0.2126,-0.2075,-0.2026,-0.198,-0.1934,-0.189,-0.1848,-0.1807,-0.1767,-0.1729,-0.1692,-0.1656,-0.1621,-0.1587,-0.1554,-0.1523,-0.1492,-0.1462,-0.1433,-0.1405,-0.1377,-0.1351,-0.1325,-0.13,-0.1276,-0.1252,-0.1229,-0.1206,-0.1185,-0.1163,-0.1143,-0.1123,-0.1103,-0.1084,-0.1065,-0.1047,-0.103,-0.1012,-0.0995,-0.0979,-0.0963,-0.0947,-0.0932,-0.0917,-0.0903,-0.0889,-0.0875,-0.0861,-0.0848,-0.0835,-0.0822,-0.081,-0.0798,-0.0786,-0.0775,-0.0763,-0.0752,-0.0742,-0.0731,-0.0721,-0.071,-0.0701,-0.0691,-0.0681,-0.0672,-0.0663,-0.0654,-0.0645,-0.0636,-0.0628,-0.062,-0.0612,-0.0604,-0.0596,-0.0588,-0.0581,-0.0573,-0.0566,-0.0559,-0.0552,-0.0545,-0.0539,-0.0532,-0.0526,-0.0519,-0.0513,-0.0507,-0.0501,-0.0495,-0.0489,-0.0484,-0.0478,-0.0472,-0.0467,-0.0462,-0.0457,-0.0451],bt:-0.0451,fc:30};
PROFILES[400] = {rp:[0.2477,0.2513,0.2563,0.2615,0.2668,0.2723,0.2779,0.2837,0.2897,0.2959,0.3023,0.3089,0.3157,0.3228,0.33,0.3375,0.3453,0.3533,0.3616,0.3702,0.3791,0.3883,0.3979,0.4078,0.4181,0.4287,0.4398,0.4512,0.4631,0.4755,0.4884,0.5018,0.5157,0.5302,0.5453,0.5611,0.5775,0.5946,0.6125,0.6311,0.6506,0.671,0.6923,0.7146,0.7379,0.7624,0.788,0.8149,0.8432,0.8728,0.904,0.9368,0.9713,1.0076,1.0459,1.0862,1.1288,1.1738,1.2213,1.2715,1.3247,1.381,1.4406,1.5039,1.571,1.6422,1.7179,1.7983,1.8838,1.9748,2.0717,2.1748,2.2847,2.4017,2.5264,2.6592,2.8007,2.9513,3.1115,3.2818,3.4627,3.6544,3.8572,4.0713,4.2967,4.5331,4.78,5.0367,5.302,5.5744,5.8518,6.1318,6.4115,6.6875,6.956,7.2132,7.4548,7.6769,7.8758,8.048,8.1911,8.3032,8.3836,8.4322,8.45,8.4389,8.4012,8.3399,8.2582,8.1593,8.0466,7.9232,7.7919,7.6554,7.5159,7.3753,7.2352,7.097,6.9616,6.8298,6.7023,6.5794,6.4613,6.3483,6.2404,6.1376,6.0397,5.9467,5.8584,5.7746,5.6952,5.62,5.5487,5.4812,5.4172,5.3566,5.2991,5.2447,5.1931,5.1441,5.0977,5.0536,5.0118,4.972,4.9342,4.8983,4.8641,4.8316,4.8006,4.7711,4.7429,4.7161,4.6905,4.666,4.6426,4.6203,4.5989,4.5785,4.5589,4.5402,4.5222,4.505,4.4885,4.4727,4.4574,4.4428,4.4288,4.4153,4.4023,4.3898,4.3778,4.3662,4.3551,4.3443,4.3339,4.3239,4.3143,4.305,4.296,4.2873,4.2789,4.2708,4.263,4.2554,4.248,4.2409,4.234,4.2274,4.2209,4.2147,4.2086,4.2027,4.197,4.1915,4.1861,4.1809,4.1758,4.1709,4.1661,4.1615,4.157,4.1526,4.1483,4.1441,4.1401,4.1362,4.1323,4.1286,4.125,4.1214,4.118,4.1146,4.1114,4.1082,4.105,4.102,4.099,4.0962,4.0933,4.0906,4.0879,4.0853,4.0827,4.0802,4.0778,4.0754,4.073,4.0707,4.0685,4.0663,4.0642,4.0621,4.0601,4.0581,4.0561,4.0542,4.0523,4.0505,4.0487,4.0469,4.0452,4.0435,4.0419,4.0403,4.0387,4.0371,4.0356,4.0341,4.0326,4.0312,4.0298],rt:4.0298,bp:[3.6747,3.671,3.666,3.6608,3.6555,3.65,3.6444,3.6386,3.6326,3.6264,3.62,3.6134,3.6066,3.5996,3.5923,3.5848,3.577,3.569,3.5607,3.5521,3.5432,3.534,3.5244,3.5145,3.5043,3.4936,3.4826,3.4711,3.4592,3.4468,3.4339,3.4205,3.4066,3.3921,3.377,3.3612,3.3448,3.3277,3.3098,3.2912,3.2717,3.2513,3.23,3.2077,3.1844,3.1599,3.1343,3.1074,3.0792,3.0495,3.0183,2.9856,2.9511,2.9147,2.8765,2.8361,2.7935,2.7486,2.701,2.6508,2.5976,2.5413,2.4817,2.4185,2.3514,2.2801,2.2045,2.124,2.0385,1.9475,1.8507,1.7475,1.6377,1.5206,1.3959,1.2631,1.1217,0.9711,0.8108,0.6405,0.4597,0.268,0.0651,-0.149,-0.3744,-0.6108,-0.8577,-1.1144,-1.3797,-1.652,-1.9295,-2.2095,-2.4892,-2.7651,-3.0337,-3.2909,-3.5325,-3.7546,-3.9534,-4.1257,-4.2688,-4.3809,-4.4612,-4.5099,-4.5277,-4.5166,-4.4789,-4.4176,-4.3359,-4.237,-4.1243,-4.0009,-3.8696,-3.7331,-3.5936,-3.453,-3.3129,-3.1747,-3.0393,-2.9075,-2.78,-2.6571,-2.539,-2.426,-2.3181,-2.2152,-2.1174,-2.0244,-1.9361,-1.8523,-1.7729,-1.6977,-1.6264,-1.5588,-1.4949,-1.4342,-1.3768,-1.3224,-1.2707,-1.2218,-1.1754,-1.1313,-1.0894,-1.0497,-1.0119,-0.976,-0.9418,-0.9093,-0.8783,-0.8488,-0.8206,-0.7938,-0.7681,-0.7437,-0.7203,-0.698,-0.6766,-0.6562,-0.6366,-0.6179,-0.5999,-0.5827,-0.5662,-0.5503,-0.5351,-0.5205,-0.5065,-0.493,-0.48,-0.4675,-0.4555,-0.4439,-0.4327,-0.422,-0.4116,-0.4016,-0.392,-0.3827,-0.3737,-0.365,-0.3566,-0.3485,-0.3406,-0.3331,-0.3257,-0.3186,-0.3117,-0.3051,-0.2986,-0.2923,-0.2863,-0.2804,-0.2747,-0.2692,-0.2638,-0.2586,-0.2535,-0.2486,-0.2438,-0.2392,-0.2346,-0.2302,-0.226,-0.2218,-0.2178,-0.2138,-0.21,-0.2063,-0.2026,-0.1991,-0.1957,-0.1923,-0.189,-0.1858,-0.1827,-0.1797,-0.1767,-0.1738,-0.171,-0.1683,-0.1656,-0.1629,-0.1604,-0.1579,-0.1554,-0.153,-0.1507,-0.1484,-0.1462,-0.144,-0.1419,-0.1398,-0.1377,-0.1357,-0.1338,-0.1319,-0.13,-0.1282,-0.1264,-0.1246,-0.1229,-0.1212,-0.1196,-0.1179,-0.1163,-0.1148,-0.1133,-0.1118,-0.1103,-0.1089,-0.1075],bt:-0.1075,fc:40};
PROFILES[500] = {rp:[0.2474,0.2503,0.2543,0.2584,0.2625,0.2668,0.2712,0.2756,0.2802,0.2849,0.2897,0.2947,0.2997,0.3049,0.3103,0.3157,0.3213,0.3271,0.333,0.3391,0.3453,0.3517,0.3583,0.365,0.372,0.3791,0.3865,0.394,0.4018,0.4098,0.4181,0.4265,0.4353,0.4443,0.4536,0.4631,0.473,0.4832,0.4937,0.5045,0.5157,0.5273,0.5392,0.5516,0.5643,0.5775,0.5911,0.6052,0.6198,0.635,0.6506,0.6668,0.6837,0.7011,0.7192,0.7379,0.7574,0.7776,0.7986,0.8205,0.8432,0.8668,0.8913,0.9169,0.9435,0.9713,1.0002,1.0303,1.0617,1.0945,1.1288,1.1646,1.202,1.241,1.2819,1.3247,1.3695,1.4163,1.4655,1.517,1.571,1.6276,1.687,1.7494,1.815,1.8838,1.9561,2.0322,2.1121,2.1962,2.2847,2.3777,2.4756,2.5785,2.6868,2.8007,2.9204,3.0462,3.1784,3.3171,3.4627,3.6151,3.7747,3.9415,4.1155,4.2967,4.4849,4.68,4.8816,5.0891,5.302,5.5194,5.7404,5.9636,6.1879,6.4115,6.6327,6.8497,7.0605,7.2629,7.4548,7.6343,7.7992,7.948,8.079,8.1911,8.2833,8.3553,8.4068,8.4382,8.45,8.4433,8.4193,8.3794,8.3251,8.2582,8.1803,8.0932,7.9984,7.8975,7.7919,7.683,7.5719,7.4597,7.3472,7.2352,7.1244,7.0154,6.9084,6.804,6.7023,6.6036,6.508,6.4155,6.3264,6.2404,6.1577,6.0783,6.0019,5.9287,5.8584,5.791,5.7265,5.6647,5.6054,5.5487,5.4944,5.4424,5.3925,5.3448,5.2991,5.2553,5.2134,5.1732,5.1346,5.0977,5.0622,5.0282,4.9956,4.9643,4.9342,4.9053,4.8776,4.8509,4.8253,4.8006,4.7769,4.754,4.732,4.7109,4.6905,4.6708,4.6519,4.6336,4.6159,4.5989,4.5825,4.5667,4.5513,4.5365,4.5222,4.5084,4.495,4.4821,4.4696,4.4574,4.4457,4.4343,4.4233,4.4127,4.4023,4.3923,4.3826,4.3731,4.364,4.3551,4.3464,4.338,4.3299,4.322,4.3143,4.3068,4.2996,4.2925,4.2856,4.2789,4.2724,4.2661,4.2599,4.2539,4.248,4.2423,4.2368,4.2314,4.2261,4.2209,4.2159,4.211,4.2062,4.2016,4.197,4.1926,4.1882,4.184,4.1799,4.1758,4.1719,4.168,4.1642,4.1606,4.157],rt:4.157,bp:[3.6749,3.672,3.668,3.6639,3.6598,3.6555,3.6512,3.6467,3.6421,3.6374,3.6326,3.6276,3.6226,3.6174,3.6121,3.6066,3.601,3.5952,3.5893,3.5833,3.577,3.5706,3.5641,3.5573,3.5503,3.5432,3.5359,3.5283,3.5205,3.5125,3.5043,3.4958,3.487,3.478,3.4687,3.4592,3.4493,3.4391,3.4286,3.4178,3.4066,3.395,3.3831,3.3708,3.358,3.3448,3.3312,3.3171,3.3025,3.2874,3.2717,3.2555,3.2387,3.2212,3.2032,3.1844,3.1649,3.1447,3.1237,3.1019,3.0792,3.0555,3.031,3.0054,2.9788,2.9511,2.9222,2.892,2.8606,2.8278,2.7935,2.7577,2.7204,2.6813,2.6404,2.5976,2.5529,2.506,2.4568,2.4054,2.3514,2.2947,2.2353,2.1729,2.1074,2.0385,1.9662,1.8901,1.8102,1.7261,1.6377,1.5446,1.4468,1.3438,1.2355,1.1217,1.0019,0.8761,0.7439,0.6052,0.4597,0.3072,0.1476,-0.0192,-0.1932,-0.3744,-0.5626,-0.7577,-0.9593,-1.1668,-1.3797,-1.5971,-1.818,-2.0413,-2.2655,-2.4892,-2.7104,-2.9274,-3.1382,-3.3406,-3.5325,-3.7119,-3.8769,-4.0257,-4.1567,-4.2688,-4.361,-4.4329,-4.4845,-4.5158,-4.5277,-4.521,-4.497,-4.4571,-4.4028,-4.3359,-4.258,-4.1708,-4.076,-3.9751,-3.8696,-3.7607,-3.6496,-3.5374,-3.4249,-3.3129,-3.2021,-3.093,-2.9861,-2.8817,-2.78,-2.6813,-2.5856,-2.4932,-2.404,-2.3181,-2.2354,-2.1559,-2.0796,-2.0063,-1.9361,-1.8687,-1.8042,-1.7423,-1.6831,-1.6264,-1.5721,-1.52,-1.4702,-1.4225,-1.3768,-1.333,-1.2911,-1.2509,-1.2123,-1.1754,-1.1399,-1.1059,-1.0733,-1.042,-1.0119,-0.983,-0.9553,-0.9286,-0.9029,-0.8783,-0.8545,-0.8317,-0.8097,-0.7885,-0.7681,-0.7485,-0.7295,-0.7113,-0.6936,-0.6766,-0.6602,-0.6443,-0.629,-0.6142,-0.5999,-0.5861,-0.5727,-0.5598,-0.5472,-0.5351,-0.5234,-0.512,-0.501,-0.4903,-0.48,-0.47,-0.4602,-0.4508,-0.4416,-0.4327,-0.4241,-0.4157,-0.4076,-0.3997,-0.392,-0.3845,-0.3772,-0.3702,-0.3633,-0.3566,-0.3501,-0.3438,-0.3376,-0.3316,-0.3257,-0.32,-0.3145,-0.309,-0.3038,-0.2986,-0.2936,-0.2887,-0.2839,-0.2792,-0.2747,-0.2702,-0.2659,-0.2617,-0.2575,-0.2535,-0.2496,-0.2457,-0.2419,-0.2382,-0.2346],bt:-0.2346,fc:50};
PROFILES[600] = {rp:[0.2473,0.2497,0.253,0.2563,0.2598,0.2632,0.2668,0.2704,0.2741,0.2779,0.2818,0.2857,0.2897,0.2939,0.298,0.3023,0.3067,0.3112,0.3157,0.3204,0.3251,0.33,0.335,0.3401,0.3453,0.3506,0.3561,0.3616,0.3673,0.3732,0.3791,0.3852,0.3915,0.3979,0.4044,0.4112,0.4181,0.4251,0.4323,0.4398,0.4474,0.4552,0.4631,0.4714,0.4798,0.4884,0.4973,0.5064,0.5157,0.5253,0.5352,0.5453,0.5558,0.5665,0.5775,0.5888,0.6005,0.6125,0.6248,0.6375,0.6506,0.6641,0.678,0.6923,0.707,0.7222,0.7379,0.7541,0.7708,0.788,0.8058,0.8242,0.8432,0.8628,0.883,0.904,0.9257,0.9481,0.9713,0.9953,1.0201,1.0459,1.0725,1.1002,1.1288,1.1585,1.1893,1.2213,1.2545,1.2889,1.3247,1.3619,1.4005,1.4406,1.4824,1.5258,1.571,1.618,1.6669,1.7179,1.7709,1.8262,1.8838,1.9438,2.0064,2.0717,2.1397,2.2107,2.2847,2.3619,2.4424,2.5264,2.614,2.7054,2.8007,2.9,3.0036,3.1115,3.2239,3.3409,3.4627,3.5892,3.7207,3.8572,3.9987,4.1452,4.2967,4.4531,4.6143,4.78,4.9501,5.1243,5.302,5.4829,5.6664,5.8518,6.0383,6.2252,6.4115,6.5961,6.778,6.956,7.129,7.2957,7.4548,7.6053,7.746,7.8758,7.9937,8.099,8.1911,8.2694,8.3336,8.3836,8.4195,8.4415,8.45,8.4457,8.4292,8.4012,8.3628,8.3148,8.2582,8.194,8.1231,8.0466,7.9653,7.8802,7.7919,7.7013,7.6091,7.5159,7.4222,7.3285,7.2352,7.1428,7.0515,6.9616,6.8733,6.7868,6.7023,6.6198,6.5395,6.4613,6.3854,6.3118,6.2404,6.1713,6.1044,6.0397,5.9772,5.9168,5.8584,5.8021,5.7477,5.6952,5.6446,5.5958,5.5487,5.5033,5.4594,5.4172,5.3764,5.3371,5.2991,5.2625,5.2272,5.1931,5.1602,5.1284,5.0977,5.0681,5.0394,5.0118,4.985,4.9592,4.9342,4.9101,4.8867,4.8641,4.8423,4.8211,4.8006,4.7808,4.7615,4.7429,4.7249,4.7074,4.6905,4.674,4.6581,4.6426,4.6276,4.6131,4.5989,4.5852,4.5719,4.5589,4.5463,4.5341,4.5222,4.5107,4.4994,4.4885,4.4779,4.4675,4.4574,4.4476,4.4381,4.4288,4.4197],rt:4.4197,bp:[3.6751,3.6726,3.6694,3.666,3.6626,3.6591,3.6555,3.6519,3.6482,3.6444,3.6405,3.6366,3.6326,3.6285,3.6243,3.62,3.6156,3.6112,3.6066,3.6019,3.5972,3.5923,3.5873,3.5822,3.577,3.5717,3.5663,3.5607,3.555,3.5492,3.5432,3.5371,3.5308,3.5244,3.5179,3.5112,3.5043,3.4972,3.49,3.4826,3.475,3.4672,3.4592,3.451,3.4426,3.4339,3.425,3.4159,3.4066,3.397,3.3871,3.377,3.3666,3.3558,3.3448,3.3335,3.3218,3.3098,3.2975,3.2848,3.2717,3.2582,3.2443,3.23,3.2153,3.2001,3.1844,3.1682,3.1515,3.1343,3.1165,3.0981,3.0792,3.0595,3.0393,3.0183,2.9967,2.9743,2.9511,2.9271,2.9022,2.8765,2.8498,2.8222,2.7935,2.7638,2.733,2.701,2.6679,2.6334,2.5976,2.5605,2.5218,2.4817,2.44,2.3965,2.3514,2.3044,2.2554,2.2045,2.1514,2.0961,2.0385,1.9785,1.9159,1.8507,1.7826,1.7117,1.6377,1.5605,1.4799,1.3959,1.3083,1.2169,1.1217,1.0223,0.9187,0.8108,0.6984,0.5814,0.4597,0.3331,0.2016,0.0651,-0.0764,-0.2229,-0.3744,-0.5308,-0.6919,-0.8577,-1.0278,-1.2019,-1.3797,-1.5606,-1.7441,-1.9295,-2.116,-2.3029,-2.4892,-2.6738,-2.8557,-3.0337,-3.2067,-3.3733,-3.5325,-3.683,-3.8236,-3.9534,-4.0714,-4.1767,-4.2688,-4.347,-4.4112,-4.4612,-4.4971,-4.5191,-4.5277,-4.5234,-4.5068,-4.4789,-4.4405,-4.3925,-4.3359,-4.2717,-4.2008,-4.1243,-4.043,-3.9578,-3.8696,-3.779,-3.6868,-3.5936,-3.4998,-3.4062,-3.3129,-3.2205,-3.1292,-3.0393,-2.951,-2.8645,-2.78,-2.6975,-2.6172,-2.539,-2.4631,-2.3895,-2.3181,-2.249,-2.1821,-2.1174,-2.0548,-1.9944,-1.9361,-1.8798,-1.8254,-1.7729,-1.7223,-1.6735,-1.6264,-1.5809,-1.5371,-1.4949,-1.4541,-1.4147,-1.3768,-1.3402,-1.3048,-1.2707,-1.2378,-1.2061,-1.1754,-1.1457,-1.1171,-1.0894,-1.0627,-1.0369,-1.0119,-0.9878,-0.9644,-0.9418,-0.9199,-0.8988,-0.8783,-0.8584,-0.8392,-0.8206,-0.8026,-0.7851,-0.7681,-0.7517,-0.7358,-0.7203,-0.7053,-0.6907,-0.6766,-0.6629,-0.6496,-0.6366,-0.624,-0.6118,-0.5999,-0.5884,-0.5771,-0.5662,-0.5555,-0.5452,-0.5351,-0.5253,-0.5158,-0.5065,-0.4974],bt:-0.4974,fc:60};
PROFILES[700] = {rp:[0.2471,0.2492,0.252,0.2549,0.2578,0.2607,0.2637,0.2668,0.2699,0.2731,0.2763,0.2796,0.2829,0.2863,0.2897,0.2933,0.2968,0.3005,0.3042,0.308,0.3118,0.3157,0.3197,0.3238,0.3279,0.3321,0.3364,0.3408,0.3453,0.3498,0.3545,0.3592,0.364,0.369,0.374,0.3791,0.3843,0.3897,0.3951,0.4007,0.4064,0.4121,0.4181,0.4241,0.4303,0.4366,0.443,0.4496,0.4563,0.4631,0.4702,0.4773,0.4847,0.4922,0.4999,0.5077,0.5157,0.5239,0.5324,0.541,0.5498,0.5588,0.568,0.5775,0.5872,0.5971,0.6073,0.6177,0.6284,0.6394,0.6506,0.6621,0.674,0.6861,0.6986,0.7113,0.7245,0.7379,0.7518,0.766,0.7806,0.7956,0.811,0.8269,0.8432,0.8599,0.8772,0.8949,0.9132,0.932,0.9513,0.9713,0.9918,1.0129,1.0347,1.0572,1.0803,1.1042,1.1288,1.1542,1.1804,1.2074,1.2354,1.2642,1.2939,1.3247,1.3565,1.3893,1.4232,1.4583,1.4946,1.5321,1.571,1.6111,1.6527,1.6958,1.7403,1.7865,1.8343,1.8838,1.9351,1.9883,2.0434,2.1005,2.1597,2.221,2.2847,2.3506,2.419,2.4899,2.5635,2.6397,2.7187,2.8007,2.8856,2.9736,3.0647,3.1591,3.2569,3.358,3.4627,3.5709,3.6827,3.7981,3.9172,4.04,4.1665,4.2967,4.4305,4.5677,4.7084,4.8524,4.9995,5.1494,5.302,5.4569,5.6137,5.7721,5.9316,6.0917,6.2519,6.4115,6.5699,6.7264,6.8803,7.0308,7.1773,7.3189,7.4548,7.5844,7.7068,7.8215,7.9278,8.0251,8.113,8.1911,8.259,8.3167,8.3639,8.4007,8.4271,8.4435,8.45,8.4471,8.4351,8.4146,8.386,8.35,8.3072,8.2582,8.2036,8.144,8.08,8.0123,7.9414,7.8677,7.7919,7.7144,7.6356,7.5559,7.4757,7.3954,7.3151,7.2352,7.1559,7.0775,6.9999,6.9236,6.8484,6.7746,6.7023,6.6315,6.5622,6.4946,6.4285,6.3642,6.3015,6.2404,6.181,6.1233,6.0672,6.0126,5.9597,5.9083,5.8584,5.81,5.763,5.7175,5.6733,5.6305,5.589,5.5487,5.5097,5.4718,5.4351,5.3995,5.365,5.3316,5.2991,5.2677,5.2371,5.2075,5.1788,5.151,5.1239,5.0977,5.0722,5.0475,5.0235,5.0002,4.9776],rt:4.9776,bp:[3.6752,3.6731,3.6703,3.6674,3.6645,3.6616,3.6586,3.6555,3.6524,3.6492,3.646,3.6428,3.6394,3.636,3.6326,3.6291,3.6255,3.6218,3.6181,3.6144,3.6105,3.6066,3.6026,3.5985,3.5944,3.5902,3.5859,3.5815,3.577,3.5725,3.5678,3.5631,3.5583,3.5533,3.5483,3.5432,3.538,3.5326,3.5272,3.5216,3.516,3.5102,3.5043,3.4982,3.4921,3.4858,3.4793,3.4728,3.466,3.4592,3.4522,3.445,3.4376,3.4301,3.4225,3.4146,3.4066,3.3984,3.39,3.3814,3.3726,3.3635,3.3543,3.3448,3.3351,3.3252,3.315,3.3046,3.2939,3.2829,3.2717,3.2602,3.2484,3.2362,3.2238,3.211,3.1979,3.1844,3.1706,3.1563,3.1417,3.1267,3.1113,3.0955,3.0792,3.0624,3.0451,3.0274,3.0091,2.9903,2.971,2.9511,2.9305,2.9094,2.8876,2.8652,2.842,2.8181,2.7935,2.7681,2.7419,2.7149,2.687,2.6581,2.6284,2.5976,2.5659,2.533,2.4991,2.464,2.4277,2.3902,2.3514,2.3112,2.2696,2.2266,2.182,2.1358,2.088,2.0385,1.9872,1.9341,1.879,1.8218,1.7627,1.7013,1.6377,1.5717,1.5033,1.4324,1.3588,1.2826,1.2036,1.1217,1.0367,0.9488,0.8576,0.7632,0.6655,0.5643,0.4597,0.3515,0.2397,0.1242,0.0051,-0.1177,-0.2442,-0.3744,-0.5081,-0.6454,-0.7861,-0.9301,-1.0772,-1.2271,-1.3797,-1.5346,-1.6914,-1.8498,-2.0093,-2.1694,-2.3296,-2.4892,-2.6475,-2.8041,-2.958,-3.1085,-3.255,-3.3966,-3.5325,-3.6621,-3.7845,-3.8992,-4.0055,-4.1028,-4.1907,-4.2688,-4.3367,-4.3943,-4.4416,-4.4783,-4.5048,-4.5212,-4.5277,-4.5248,-4.5128,-4.4922,-4.4637,-4.4277,-4.3849,-4.3359,-4.2813,-4.2217,-4.1577,-4.09,-4.019,-3.9454,-3.8696,-3.7921,-3.7133,-3.6336,-3.5534,-3.4731,-3.3928,-3.3129,-3.2336,-3.1551,-3.0776,-3.0012,-2.9261,-2.8523,-2.78,-2.7092,-2.6399,-2.5722,-2.5062,-2.4419,-2.3791,-2.3181,-2.2587,-2.201,-2.1448,-2.0903,-2.0374,-1.986,-1.9361,-1.8877,-1.8407,-1.7952,-1.751,-1.7082,-1.6666,-1.6264,-1.5873,-1.5495,-1.5128,-1.4772,-1.4427,-1.4092,-1.3768,-1.3453,-1.3148,-1.2852,-1.2565,-1.2286,-1.2016,-1.1754,-1.1499,-1.1252,-1.1012,-1.0779,-1.0552],bt:-1.0552,fc:70};
PROFILES[800] = {rp:[0.2471,0.2489,0.2513,0.2538,0.2563,0.2589,0.2615,0.2641,0.2668,0.2695,0.2723,0.2751,0.2779,0.2808,0.2837,0.2867,0.2897,0.2928,0.2959,0.2991,0.3023,0.3056,0.3089,0.3123,0.3157,0.3192,0.3228,0.3264,0.33,0.3337,0.3375,0.3414,0.3453,0.3493,0.3533,0.3574,0.3616,0.3659,0.3702,0.3746,0.3791,0.3837,0.3883,0.3931,0.3979,0.4028,0.4078,0.4129,0.4181,0.4233,0.4287,0.4342,0.4398,0.4454,0.4512,0.4571,0.4631,0.4693,0.4755,0.4819,0.4884,0.495,0.5018,0.5087,0.5157,0.5229,0.5302,0.5377,0.5453,0.5531,0.5611,0.5692,0.5775,0.586,0.5946,0.6034,0.6125,0.6217,0.6311,0.6408,0.6506,0.6607,0.671,0.6815,0.6923,0.7033,0.7146,0.7261,0.7379,0.75,0.7624,0.7751,0.788,0.8013,0.8149,0.8289,0.8432,0.8578,0.8728,0.8882,0.904,0.9202,0.9368,0.9538,0.9713,0.9892,1.0076,1.0265,1.0459,1.0658,1.0862,1.1072,1.1288,1.151,1.1738,1.1972,1.2213,1.2461,1.2715,1.2977,1.3247,1.3524,1.381,1.4104,1.4406,1.4718,1.5039,1.5369,1.571,1.606,1.6422,1.6794,1.7179,1.7574,1.7983,1.8404,1.8838,1.9286,1.9748,2.0225,2.0717,2.1224,2.1748,2.2289,2.2847,2.3423,2.4017,2.4631,2.5264,2.5917,2.6592,2.7288,2.8007,2.8748,2.9513,3.0302,3.1115,3.1954,3.2818,3.3709,3.4627,3.5571,3.6544,3.7544,3.8572,3.9629,4.0713,4.1826,4.2967,4.4135,4.5331,4.6553,4.78,4.9072,5.0367,5.1684,5.302,5.4374,5.5744,5.7126,5.8518,5.9916,6.1318,6.2719,6.4115,6.5502,6.6875,6.8229,6.956,7.0863,7.2132,7.3362,7.4548,7.5686,7.6769,7.7795,7.8758,7.9654,8.048,8.1233,8.1911,8.2511,8.3032,8.3474,8.3836,8.4118,8.4322,8.4449,8.45,8.4479,8.4389,8.4232,8.4012,8.3734,8.3399,8.3014,8.2582,8.2107,8.1593,8.1045,8.0466,7.9861,7.9232,7.8584,7.7919,7.7242,7.6554,7.5859,7.5159,7.4456,7.3753,7.3051,7.2352,7.1658,7.097,7.0289,6.9616,6.8952,6.8298,6.7655,6.7023,6.6402,6.5794,6.5197,6.4613,6.4042,6.3483,6.2938,6.2404,6.1884,6.1376],rt:6.1376,bp:[3.6753,3.6735,3.671,3.6685,3.666,3.6634,3.6608,3.6582,3.6555,3.6528,3.65,3.6472,3.6444,3.6415,3.6386,3.6356,3.6326,3.6295,3.6264,3.6232,3.62,3.6167,3.6134,3.61,3.6066,3.6031,3.5996,3.596,3.5923,3.5886,3.5848,3.5809,3.577,3.5731,3.569,3.5649,3.5607,3.5564,3.5521,3.5477,3.5432,3.5386,3.534,3.5293,3.5244,3.5195,3.5145,3.5094,3.5043,3.499,3.4936,3.4881,3.4826,3.4769,3.4711,3.4652,3.4592,3.453,3.4468,3.4404,3.4339,3.4273,3.4205,3.4136,3.4066,3.3994,3.3921,3.3846,3.377,3.3692,3.3612,3.3531,3.3448,3.3364,3.3277,3.3189,3.3098,3.3006,3.2912,3.2816,3.2717,3.2616,3.2513,3.2408,3.23,3.219,3.2077,3.1962,3.1844,3.1723,3.1599,3.1473,3.1343,3.121,3.1074,3.0934,3.0792,3.0645,3.0495,3.0341,3.0183,3.0022,2.9856,2.9685,2.9511,2.9331,2.9147,2.8959,2.8765,2.8566,2.8361,2.8151,2.7935,2.7713,2.7486,2.7251,2.701,2.6763,2.6508,2.6246,2.5976,2.5699,2.5413,2.512,2.4817,2.4505,2.4185,2.3854,2.3514,2.3163,2.2801,2.2429,2.2045,2.1649,2.124,2.0819,2.0385,1.9937,1.9475,1.8998,1.8507,1.7999,1.7475,1.6935,1.6377,1.5801,1.5206,1.4593,1.3959,1.3306,1.2631,1.1935,1.1217,1.0475,0.9711,0.8922,0.8108,0.7269,0.6405,0.5514,0.4597,0.3652,0.268,0.1679,0.0651,-0.0405,-0.149,-0.2603,-0.3744,-0.4912,-0.6108,-0.733,-0.8577,-0.9849,-1.1144,-1.2461,-1.3797,-1.5151,-1.652,-1.7903,-1.9295,-2.0693,-2.2095,-2.3496,-2.4892,-2.6278,-2.7651,-2.9006,-3.0337,-3.164,-3.2909,-3.4139,-3.5325,-3.6462,-3.7546,-3.8571,-3.9534,-4.0431,-4.1257,-4.201,-4.2688,-4.3288,-4.3809,-4.4251,-4.4612,-4.4895,-4.5099,-4.5225,-4.5277,-4.5256,-4.5166,-4.5009,-4.4789,-4.451,-4.4176,-4.3791,-4.3359,-4.2884,-4.237,-4.1822,-4.1243,-4.0637,-4.0009,-3.936,-3.8696,-3.8018,-3.7331,-3.6636,-3.5936,-3.5233,-3.453,-3.3828,-3.3129,-3.2435,-3.1747,-3.1066,-3.0393,-2.9729,-2.9075,-2.8432,-2.78,-2.7179,-2.6571,-2.5974,-2.539,-2.4819,-2.426,-2.3714,-2.3181,-2.266,-2.2152],bt:-2.2152,fc:80};
PROFILES[900] = {rp:[0.247,0.2486,0.2508,0.253,0.2552,0.2575,0.2598,0.2621,0.2644,0.2668,0.2692,0.2717,0.2741,0.2767,0.2792,0.2818,0.2844,0.2871,0.2897,0.2925,0.2952,0.298,0.3009,0.3038,0.3067,0.3097,0.3127,0.3157,0.3188,0.322,0.3251,0.3284,0.3317,0.335,0.3384,0.3418,0.3453,0.3488,0.3524,0.3561,0.3598,0.3635,0.3673,0.3712,0.3751,0.3791,0.3832,0.3873,0.3915,0.3957,0.4001,0.4044,0.4089,0.4134,0.4181,0.4227,0.4275,0.4323,0.4373,0.4423,0.4474,0.4525,0.4578,0.4631,0.4686,0.4741,0.4798,0.4855,0.4913,0.4973,0.5033,0.5095,0.5157,0.5221,0.5286,0.5352,0.5419,0.5488,0.5558,0.5629,0.5701,0.5775,0.585,0.5927,0.6005,0.6084,0.6165,0.6248,0.6333,0.6418,0.6506,0.6596,0.6687,0.678,0.6875,0.6972,0.707,0.7171,0.7274,0.7379,0.7487,0.7596,0.7708,0.7822,0.7939,0.8058,0.818,0.8304,0.8432,0.8562,0.8695,0.883,0.8969,0.9111,0.9257,0.9405,0.9557,0.9713,0.9872,1.0034,1.0201,1.0372,1.0546,1.0725,1.0908,1.1096,1.1288,1.1485,1.1686,1.1893,1.2105,1.2322,1.2545,1.2773,1.3007,1.3247,1.3493,1.3746,1.4005,1.4271,1.4544,1.4824,1.5111,1.5406,1.571,1.6021,1.6341,1.6669,1.7006,1.7353,1.7709,1.8075,1.8451,1.8838,1.9235,1.9644,2.0064,2.0496,2.094,2.1397,2.1867,2.235,2.2847,2.3358,2.3883,2.4424,2.498,2.5552,2.614,2.6745,2.7367,2.8007,2.8664,2.9341,3.0036,3.075,3.1485,3.2239,3.3014,3.381,3.4627,3.5465,3.6325,3.7207,3.8112,3.9038,3.9987,4.0958,4.1951,4.2967,4.4004,4.5063,4.6143,4.7243,4.8363,4.9501,5.0658,5.1831,5.302,5.4223,5.5438,5.6664,5.7898,5.9139,6.0383,6.1629,6.2874,6.4115,6.5348,6.6571,6.778,6.8972,7.0143,7.129,7.2409,7.3496,7.4548,7.5562,7.6533,7.746,7.8338,7.9164,7.9937,8.0654,8.1312,8.1911,8.2448,8.2923,8.3336,8.3685,8.3971,8.4195,8.4356,8.4458,8.45,8.4485,8.4415,8.4292,8.4118,8.3896,8.3628,8.3318,8.2968,8.2582,8.2162,8.1711,8.1231,8.0727,8.02,7.9653,7.9089],rt:7.9089,bp:[3.6753,3.6737,3.6716,3.6694,3.6671,3.6649,3.6626,3.6603,3.6579,3.6555,3.6531,3.6507,3.6482,3.6457,3.6431,3.6405,3.6379,3.6353,3.6326,3.6298,3.6271,3.6243,3.6214,3.6186,3.6156,3.6127,3.6097,3.6066,3.6035,3.6004,3.5972,3.5939,3.5907,3.5873,3.5839,3.5805,3.577,3.5735,3.5699,3.5663,3.5626,3.5588,3.555,3.5511,3.5472,3.5432,3.5391,3.535,3.5308,3.5266,3.5223,3.5179,3.5134,3.5089,3.5043,3.4996,3.4948,3.49,3.4851,3.4801,3.475,3.4698,3.4645,3.4592,3.4537,3.4482,3.4426,3.4368,3.431,3.425,3.419,3.4129,3.4066,3.4002,3.3937,3.3871,3.3804,3.3735,3.3666,3.3595,3.3522,3.3448,3.3373,3.3297,3.3218,3.3139,3.3058,3.2975,3.2891,3.2805,3.2717,3.2628,3.2536,3.2443,3.2349,3.2252,3.2153,3.2052,3.1949,3.1844,3.1737,3.1627,3.1515,3.1401,3.1284,3.1165,3.1043,3.0919,3.0792,3.0662,3.0529,3.0393,3.0254,3.0112,2.9967,2.9818,2.9666,2.9511,2.9352,2.9189,2.9022,2.8852,2.8677,2.8498,2.8315,2.8127,2.7935,2.7738,2.7537,2.733,2.7118,2.6901,2.6679,2.645,2.6216,2.5976,2.573,2.5478,2.5218,2.4953,2.468,2.44,2.4112,2.3817,2.3514,2.3202,2.2883,2.2554,2.2217,2.187,2.1514,2.1148,2.0772,2.0385,1.9988,1.9579,1.9159,1.8727,1.8283,1.7826,1.7356,1.6873,1.6377,1.5866,1.534,1.4799,1.4243,1.3671,1.3083,1.2478,1.1856,1.1217,1.0559,0.9883,0.9187,0.8473,0.7739,0.6984,0.6209,0.5414,0.4597,0.3758,0.2898,0.2016,0.1112,0.0185,-0.0764,-0.1735,-0.2728,-0.3744,-0.4781,-0.584,-0.6919,-0.802,-0.9139,-1.0278,-1.1435,-1.2608,-1.3797,-1.5,-1.6215,-1.7441,-1.8675,-1.9916,-2.116,-2.2406,-2.3651,-2.4892,-2.6125,-2.7348,-2.8557,-2.9749,-3.092,-3.2067,-3.3186,-3.4273,-3.5325,-3.6339,-3.731,-3.8236,-3.9114,-3.9941,-4.0714,-4.1431,-4.2089,-4.2688,-4.3225,-4.37,-4.4112,-4.4462,-4.4748,-4.4971,-4.5133,-4.5235,-4.5277,-4.5262,-4.5192,-4.5068,-4.4894,-4.4672,-4.4405,-4.4095,-4.3745,-4.3359,-4.2939,-4.2487,-4.2008,-4.1504,-4.0977,-4.043,-3.9866],bt:-3.9866,fc:90};

// Fault display geometry: (0,0) to (100,-20), 100 nodes
var FAULT_X = [0.0,1.0101,2.0202,3.0303,4.0404,5.0505,6.0606,7.0707,8.0808,9.0909,10.101,11.1111,12.1212,13.1313,14.1414,15.1515,16.1616,17.1717,18.1818,19.1919,20.202,21.2121,22.2222,23.2323,24.2424,25.2525,26.2626,27.2727,28.2828,29.2929,30.303,31.3131,32.3232,33.3333,34.3434,35.3535,36.3636,37.3737,38.3838,39.3939,40.404,41.4141,42.4242,43.4343,44.4444,45.4545,46.4646,47.4747,48.4848,49.4949,50.5051,51.5152,52.5253,53.5354,54.5455,55.5556,56.5657,57.5758,58.5859,59.596,60.6061,61.6162,62.6263,63.6364,64.6465,65.6566,66.6667,67.6768,68.6869,69.697,70.7071,71.7172,72.7273,73.7374,74.7475,75.7576,76.7677,77.7778,78.7879,79.798,80.8081,81.8182,82.8283,83.8384,84.8485,85.8586,86.8687,87.8788,88.8889,89.899,90.9091,91.9192,92.9293,93.9394,94.9495,95.9596,96.9697,97.9798,98.9899,100.0];
var FAULT_Z = [0.0,-0.202,-0.404,-0.6061,-0.8081,-1.0101,-1.2121,-1.4141,-1.6162,-1.8182,-2.0202,-2.2222,-2.4242,-2.6263,-2.8283,-3.0303,-3.2323,-3.4343,-3.6364,-3.8384,-4.0404,-4.2424,-4.4444,-4.6465,-4.8485,-5.0505,-5.2525,-5.4545,-5.6566,-5.8586,-6.0606,-6.2626,-6.4646,-6.6667,-6.8687,-7.0707,-7.2727,-7.4747,-7.6768,-7.8788,-8.0808,-8.2828,-8.4848,-8.6869,-8.8889,-9.0909,-9.2929,-9.4949,-9.697,-9.899,-10.101,-10.303,-10.5051,-10.7071,-10.9091,-11.1111,-11.3131,-11.5152,-11.7172,-11.9192,-12.1212,-12.3232,-12.5253,-12.7273,-12.9293,-13.1313,-13.3333,-13.5354,-13.7374,-13.9394,-14.1414,-14.3434,-14.5455,-14.7475,-14.9495,-15.1515,-15.3535,-15.5556,-15.7576,-15.9596,-16.1616,-16.3636,-16.5657,-16.7677,-16.9697,-17.1717,-17.3737,-17.5758,-17.7778,-17.9798,-18.1818,-18.3838,-18.5859,-18.7879,-18.9899,-19.1919,-19.3939,-19.596,-19.798,-20.0];

var NX = 251;
var X_END = 100.0; // km
var DX = X_END / (NX - 1); // 0.4 km
var K = 1e-4;
var M_EXP = 0.5;
var N_EXP = 1.0;
var H_EXP = 1.67;
var DT = 1; // 1 year per step
var STEPS_PER_FRAME = 20;

var upliftRed = new Float64Array(NX);
var upliftBlue = new Float64Array(NX);
var xGrid = new Float64Array(NX);
var DA = new Float64Array(NX);
var currentFaultCut = 50;

for (var i = 0; i < NX; i++) {
  xGrid[i] = i * DX;
  var Lx = X_END - xGrid[i];
  DA[i] = Math.max(Math.pow(Math.max(Lx, 0), H_EXP), 1.0);
}

function loadProfile(nLocked) {
  var prof = PROFILES[nLocked];
  if (!prof) return;
  for (var i = 0; i < NX; i++) {
    var rv = (i < prof.rp.length) ? prof.rp[i] : prof.rt;
    var bv = (i < prof.bp.length) ? prof.bp[i] : prof.bt;
    upliftRed[i] = rv * 1e-6;  // mm/yr -> km/yr
    upliftBlue[i] = bv * 1e-6;
  }
  currentFaultCut = prof.fc;
}

loadProfile(500); // default

/* ================================================================
   Section 1: DOM Refs & Canvas Setup
   ================================================================ */
var canvasTopo   = document.getElementById("canvas-topo");
var canvasUplift = document.getElementById("canvas-uplift");
var canvasFault  = document.getElementById("canvas-fault");
var DPR = window.devicePixelRatio || 1;

function initCanvas(canvas, w, h) {
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    canvas.width = w * DPR;
    canvas.height = h * DPR;
    var ctx = canvas.getContext("2d");
    ctx.scale(DPR, DPR);
    return ctx;
}

var ctxTopo   = initCanvas(canvasTopo, 840, 260);
var ctxUplift = initCanvas(canvasUplift, 840, 200);
var ctxFault  = initCanvas(canvasFault, 840, 240);

var btnPlay  = document.getElementById("btn-play");
var btnPause = document.getElementById("btn-pause");
var btnReset = document.getElementById("btn-reset");
var slInterval = document.getElementById("sl-interval");
var valInterval = document.getElementById("val-interval");
var slLocked = document.getElementById("sl-locked");
var valLocked = document.getElementById("val-locked");
var slSpeed = document.getElementById("sl-speed");
var valSpeed = document.getElementById("val-speed");
var infoTime = document.getElementById("info-time");
var infoMaxZ = document.getElementById("info-maxz");
var infoEq   = document.getElementById("info-eq");
var infoNext = document.getElementById("info-next");

/* ================================================================
   Section 2: TVD Solver & Utilities
   ================================================================ */

function getNiceTicks(min, max, numTicks) {
    var range = max - min;
    if (range === 0) return [min];
    var step = Math.pow(10, Math.floor(Math.log10(range / numTicks)));
    var err = numTicks / (range / step);
    if (err <= .15) step *= 10;
    else if (err <= .35) step *= 5;
    else if (err <= .75) step *= 2;
    var ticks = [];
    var start = Math.ceil(min / step) * step;
    for (var val = start; val <= max + 1e-9; val += step) {
        ticks.push(parseFloat(val.toPrecision(10)));
    }
    return ticks;
}

function fillDepressions(z) {
  var max_val = z[0];
  for (var i = 1; i < z.length; i++) {
    if (z[i] < max_val) {
        z[i] = max_val;
    } else {
        max_val = z[i];
    }
  }
}

function tvdErosionStep(z, dx, dtMacro, Ke, m, n, DA, cfl) {
    var nx = z.length;
    var a = new Float64Array(nx);

    for (var i = 0; i < nx; i++) {
        var slope = (i < nx - 1) ? ((z[i+1] - z[i]) / dx) : ((z[i] - z[i-1]) / dx);
        if (slope < 0) slope = 0;

        var c = Ke * Math.pow(Math.max(DA[i], 1e-12), m);
        if (n !== 1.0) c = c * Math.pow(slope, n - 1.0);
        a[i] = c;
    }

    var a_max = 0;
    for (var i = 0; i < nx; i++) { if (a[i] > a_max) a_max = a[i]; }

    var dt_sub = dtMacro;
    if (a_max > 0) {
        var dt_allow = cfl * dx / a_max;
        if (dt_allow < dt_sub) dt_sub = dt_allow;
    }

    var steps = Math.ceil(dtMacro / dt_sub);
    dt_sub = dtMacro / steps;

    var z_new = new Float64Array(nx);
    var r = new Float64Array(nx);
    var phi = new Float64Array(nx);

    for (var s = 0; s < steps; s++) {
        for (var i = 0; i < nx; i++) {
            var dz_local = (i < nx - 1) ? (z[i+1] - z[i]) : 0;
            var dz_up = (i > 0) ? (z[i] - z[i-1]) : 0;
            if (Math.abs(dz_local) > 1e-12) r[i] = dz_up / dz_local;
            else r[i] = 1.0;
        }

        for (var i = 0; i < nx; i++) {
            phi[i] = (r[i] + Math.abs(r[i])) / (1.0 + Math.abs(r[i]));
        }

        for (var i = 1; i < nx - 1; i++) {
            var a_val = a[i];
            var z_val = z[i];
            var zr_val = z[i+1];
            var zl_val = z[i-1];

            var phi_R = phi[i];
            var phi_L = phi[i-1];

            var Fr_low = a_val * z_val;
            var Fr_high = 0.5 * a_val * (z_val + zr_val) - 0.5 * a_val * a_val * (dt_sub / dx) * (zr_val - z_val);
            var Fr = Fr_low + phi_R * (Fr_high - Fr_low);

            var Fl_low = a_val * zl_val;
            var Fl_high = 0.5 * a_val * (zl_val + z_val) - 0.5 * a_val * a_val * (dt_sub / dx) * (z_val - zl_val);
            var Fl = Fl_low + phi_L * (Fl_high - Fl_low);

            z_new[i] = z[i] - (dt_sub / dx) * (Fr - Fl);
        }
        z_new[0] = 0.0;
        z_new[nx-1] = z_new[nx-2];

        for (var i = 0; i < nx; i++) z[i] = Math.max(0, z_new[i]);
    }
    return z;
}

/* ================================================================
   Section 3: Plot Rendering
   ================================================================ */
var PAD = { left: 60, right: 20, top: 20, bottom: 40 };

function makePlotTransform(cw, ch, xMin, xMax, yMin, yMax) {
  var pw = cw - PAD.left - PAD.right;
  var ph = ch - PAD.top - PAD.bottom;
  return {
    xMin: xMin, xMax: xMax, yMin: yMin, yMax: yMax, pw: pw, ph: ph,
    toCanvasX: function (x) { return PAD.left + (x - xMin) / (xMax - xMin) * pw; },
    toCanvasY: function (y) { return PAD.top + (1 - (y - yMin) / (yMax - yMin)) * ph; }
  };
}

function drawAxes(ctx, t, xLabel, yLabel, xTicks, yTicks, yTickLabels) {
    if (!yTickLabels) yTickLabels = yTicks;

    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1.5;
    ctx.beginPath();

    var x0 = t.toCanvasX(t.xMin);
    var x1 = t.toCanvasX(t.xMax);
    var y0 = t.toCanvasY(t.yMin);
    var y1 = t.toCanvasY(t.yMax);

    ctx.moveTo(x0, y0); ctx.lineTo(x1, y0);
    ctx.moveTo(x0, y0); ctx.lineTo(x0, y1);
    ctx.stroke();

    ctx.fillStyle = "#333";
    ctx.font = "12px sans-serif";

    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    for(var i=0; i<xTicks.length; i++) {
        var x = xTicks[i];
        var cx = t.toCanvasX(x);
        ctx.beginPath(); ctx.moveTo(cx, y0); ctx.lineTo(cx, y0+5); ctx.stroke();
        ctx.fillText(x, cx, y0+8);
    }
    ctx.fillText(xLabel, (x0+x1)/2, y0 + 25);

    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    for(var i=0; i<yTicks.length; i++) {
        var y = yTicks[i];
        var lbl = yTickLabels[i];
        var cy = t.toCanvasY(y);
        ctx.beginPath(); ctx.moveTo(x0, cy); ctx.lineTo(x0-5, cy); ctx.stroke();
        ctx.fillText(lbl, x0-8, cy);
    }

    ctx.save();
    ctx.translate(x0 - 45, (y0+y1)/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign = "center";
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();
}

function renderTopo(topoZ, rawZ) {
  var cw = canvasTopo.width / DPR, ch = canvasTopo.height / DPR;

  var zMax = 0;
  for (var i = 0; i < NX; i++) { if (topoZ[i] > zMax) zMax = topoZ[i]; }
  zMax = Math.max(zMax, 0.005) * 1.2;
  var zMin = 0;

  var t = makePlotTransform(cw, ch, 0, 100, zMin, zMax);
  ctxTopo.clearRect(0, 0, cw, ch);

  var yTicksKm = getNiceTicks(zMin, zMax, 4);
  var yTicksM = yTicksKm.map(function(y) { return (y * 1000).toFixed(1); });

  drawAxes(ctxTopo, t, "Distance from MFT (km)", "Elevation (m)", [0, 20, 40, 60, 80, 100], yTicksKm, yTicksM);

  // Terrain Fill (Gray)
  ctxTopo.fillStyle = "rgba(180, 180, 180, 0.5)";
  ctxTopo.beginPath();
  ctxTopo.moveTo(t.toCanvasX(xGrid[0]), t.toCanvasY(0));
  for (var i = 0; i < NX; i++) {
    ctxTopo.lineTo(t.toCanvasX(xGrid[i]), t.toCanvasY(topoZ[i]));
  }
  ctxTopo.lineTo(t.toCanvasX(xGrid[NX - 1]), t.toCanvasY(0));
  ctxTopo.closePath();
  ctxTopo.fill();

  // Lake fill overlay
  if (rawZ) {
    ctxTopo.fillStyle = "rgba(41, 128, 185, 0.6)";
    ctxTopo.beginPath();
    ctxTopo.moveTo(t.toCanvasX(xGrid[0]), t.toCanvasY(topoZ[0]));
    for (var i = 1; i < NX; i++) {
      ctxTopo.lineTo(t.toCanvasX(xGrid[i]), t.toCanvasY(topoZ[i]));
    }
    for (var i = NX - 1; i >= 0; i--) {
      ctxTopo.lineTo(t.toCanvasX(xGrid[i]), t.toCanvasY(rawZ[i]));
    }
    ctxTopo.closePath();
    ctxTopo.fill();
  }

  // Topographic Line (Black)
  ctxTopo.strokeStyle = "#000000";
  ctxTopo.lineWidth = 2;
  ctxTopo.beginPath();
  for (var i = 0; i < NX; i++) {
    var px = t.toCanvasX(xGrid[i]);
    var py = t.toCanvasY(topoZ[i]);
    if (i === 0) ctxTopo.moveTo(px, py); else ctxTopo.lineTo(px, py);
  }
  ctxTopo.stroke();
}

function renderUplift(eqFlash) {
  var cw = canvasUplift.width / DPR, ch = canvasUplift.height / DPR;

  // Compute y range from data (mm/yr)
  var yMin = 1e9, yMax = -1e9;
  for (var i = 0; i < NX; i++) {
    var rv = upliftRed[i] * 1e6;
    var bv = upliftBlue[i] * 1e6;
    if (rv < yMin) yMin = rv; if (rv > yMax) yMax = rv;
    if (bv < yMin) yMin = bv; if (bv > yMax) yMax = bv;
  }
  var pad = (yMax - yMin) * 0.1;
  yMin -= pad; yMax += pad;

  var t = makePlotTransform(cw, ch, 0, 100, yMin, yMax);
  ctxUplift.clearRect(0, 0, cw, ch);

  var yTicks = getNiceTicks(yMin, yMax, 4);
  drawAxes(ctxUplift, t, "Distance from MFT (km)", "Uplift (mm/yr)", [0, 20, 40, 60, 80, 100], yTicks);

  // Zero line
  ctxUplift.strokeStyle = "#ccc";
  ctxUplift.lineWidth = 1;
  ctxUplift.setLineDash([4, 4]);
  ctxUplift.beginPath();
  ctxUplift.moveTo(t.toCanvasX(0), t.toCanvasY(0));
  ctxUplift.lineTo(t.toCanvasX(100), t.toCanvasY(0));
  ctxUplift.stroke();
  ctxUplift.setLineDash([]);

  var eqInterval = getInterval();
  var isSteady = (eqInterval === 0);
  var isNever = (eqInterval > 10000);

  // Determine active state: red = interseismic active, blue = coseismic active
  var redActive = true;  // interseismic always active except during EQ flash at steady state
  var blueActive = isSteady || eqFlash;

  // Draw inactive curve first (behind), then active on top
  // Interseismic (red/diff_v)
  ctxUplift.strokeStyle = redActive ? "#e74c3c" : "rgba(150,150,150,0.4)";
  ctxUplift.lineWidth = redActive ? 2.5 : 1;
  ctxUplift.beginPath();
  for (var i = 0; i < NX; i++) {
    var px = t.toCanvasX(xGrid[i]);
    var py = t.toCanvasY(upliftRed[i] * 1e6);
    if (i === 0) ctxUplift.moveTo(px, py); else ctxUplift.lineTo(px, py);
  }
  ctxUplift.stroke();

  // Coseismic (blue/U2_total)
  ctxUplift.strokeStyle = blueActive ? "#2980b9" : "rgba(150,150,150,0.4)";
  ctxUplift.lineWidth = blueActive ? 2.5 : 1;
  ctxUplift.beginPath();
  for (var i = 0; i < NX; i++) {
    var px = t.toCanvasX(xGrid[i]);
    var py = t.toCanvasY(upliftBlue[i] * 1e6);
    if (i === 0) ctxUplift.moveTo(px, py); else ctxUplift.lineTo(px, py);
  }
  ctxUplift.stroke();

  // Legend (bottom-right, outside data region)
  var lx = cw - PAD.right - 190, ly = ch - PAD.bottom + 28;
  ctxUplift.font = "11px sans-serif";
  ctxUplift.textAlign = "left";
  ctxUplift.textBaseline = "middle";

  ctxUplift.strokeStyle = "#e74c3c"; ctxUplift.lineWidth = 2.5;
  ctxUplift.beginPath(); ctxUplift.moveTo(lx, ly); ctxUplift.lineTo(lx+20, ly); ctxUplift.stroke();
  ctxUplift.fillStyle = "#333"; ctxUplift.fillText("Interseismic", lx+25, ly);

  ctxUplift.strokeStyle = "#2980b9"; ctxUplift.lineWidth = 2.5;
  ctxUplift.beginPath(); ctxUplift.moveTo(lx+110, ly); ctxUplift.lineTo(lx+130, ly); ctxUplift.stroke();
  ctxUplift.fillStyle = "#333"; ctxUplift.fillText("Coseismic", lx+135, ly);
}

function renderFault(eqFlash) {
  var cw = canvasFault.width / DPR, ch = canvasFault.height / DPR;
  var t = makePlotTransform(cw, ch, 0, 100, -22, 2);

  ctxFault.clearRect(0, 0, cw, ch);

  var yTicks = [-20, -15, -10, -5, 0];
  drawAxes(ctxFault, t, "Distance from MFT (km)", "Depth (km)", [0, 20, 40, 60, 80, 100], yTicks);

  var colorActive = "#e74c3c", colorInactive = "#95a5a6";
  var widthActive = 3.5, widthInactive = 1.5;

  var eqInterval = getInterval();
  var allActive = (eqInterval === 0);

  // Shallow (0 to faultCut): normally CREEPING (red)
  var colorShallow = allActive ? colorActive : ((!eqFlash) ? colorActive : colorInactive);
  var widthShallow = allActive ? widthActive : ((!eqFlash) ? widthActive : widthInactive);

  // Deep (faultCut to end): normally LOCKED (gray), flashes red during EQ
  var colorDeep = allActive ? colorActive : (eqFlash ? colorActive : colorInactive);
  var widthDeep = allActive ? widthActive : (eqFlash ? widthActive : widthInactive);

  // Draw Shallow (Creeping)
  ctxFault.strokeStyle = colorShallow;
  ctxFault.lineWidth = widthShallow;
  ctxFault.beginPath();
  for (var i = 0; i <= currentFaultCut && i < FAULT_X.length; i++) {
    var cx = t.toCanvasX(FAULT_X[i]);
    var cy = t.toCanvasY(FAULT_Z[i]);
    if (i === 0) ctxFault.moveTo(cx, cy);
    else ctxFault.lineTo(cx, cy);
  }
  ctxFault.stroke();

  // Draw Deep (Locked)
  ctxFault.strokeStyle = colorDeep;
  ctxFault.lineWidth = widthDeep;
  ctxFault.beginPath();
  for (var i = currentFaultCut; i < FAULT_X.length; i++) {
    var cx = t.toCanvasX(FAULT_X[i]);
    var cy = t.toCanvasY(FAULT_Z[i]);
    if (i === currentFaultCut) ctxFault.moveTo(cx, cy);
    else ctxFault.lineTo(cx, cy);
  }
  ctxFault.stroke();
}

/* ================================================================
   Section 4: Simulation State & Loop
   ================================================================ */
var topoZ = new Float64Array(NX);
var rawZ  = new Float64Array(NX);
var simTime = 0;
var eqCount = 0;
var timeSinceLastEq = 0;
var eqFlashFrames = 0;
var playing = false;
var animFrameId = null;

function getInterval() { return parseInt(slInterval.value); }

function doStep() {
  var eqInterval = getInterval();

  if (eqInterval === 0) {
    for (var i = 1; i < NX; i++) {
      topoZ[i] += (upliftRed[i] + upliftBlue[i]) * DT;
    }
  } else if (eqInterval > 10000) {
    for (var i = 1; i < NX; i++) {
      topoZ[i] += upliftRed[i] * DT;
    }
  } else {
    for (var i = 1; i < NX; i++) {
      topoZ[i] += upliftRed[i] * DT;
    }
    timeSinceLastEq += DT;
    if (timeSinceLastEq >= eqInterval) {
      for (var i = 1; i < NX; i++) {
        topoZ[i] += upliftBlue[i] * eqInterval;
      }
      timeSinceLastEq = 0;
      eqCount++;
      eqFlashFrames = 15;
    }
  }

  topoZ = tvdErosionStep(topoZ, DX, DT, K, M_EXP, N_EXP, DA, 0.9);

  for (var i = 0; i < NX; i++) { rawZ[i] = topoZ[i]; }
  fillDepressions(topoZ);

  simTime += DT;
}

function updateInfo() {
  var eqInterval = getInterval();
  infoTime.textContent = simTime;
  var maxZ = 0;
  for (var i = 0; i < NX; i++) if (topoZ[i] > maxZ) maxZ = topoZ[i];
  infoMaxZ.textContent = (maxZ * 1000).toFixed(2);
  infoEq.textContent = eqCount;
  if (eqInterval === 0) {
    infoNext.textContent = "N/A";
  } else if (eqInterval > 10000) {
    infoNext.textContent = "Never";
  } else {
    infoNext.textContent = Math.max(0, eqInterval - timeSinceLastEq);
  }
}

function animate() {
  if (!playing) return;

  for (var s = 0; s < STEPS_PER_FRAME; s++) {
    doStep();
  }

  var flash = eqFlashFrames > 0;
  if (eqFlashFrames > 0) eqFlashFrames--;

  renderTopo(topoZ, rawZ);
  renderUplift(flash);
  renderFault(flash);
  updateInfo();

  animFrameId = requestAnimationFrame(animate);
}

function play() {
  playing = true;
  btnPlay.disabled = true;
  btnPause.disabled = false;
  animFrameId = requestAnimationFrame(animate);
}

function pause() {
  playing = false;
  btnPlay.disabled = false;
  btnPause.disabled = true;
  if (animFrameId) cancelAnimationFrame(animFrameId);
}

function reset() {
  pause();
  simTime = 0;
  eqCount = 0;
  timeSinceLastEq = 0;
  eqFlashFrames = 0;
  topoZ = new Float64Array(NX);
  rawZ  = new Float64Array(NX);
  renderTopo(topoZ, rawZ);
  renderUplift(false);
  renderFault(false);
  updateInfo();
}

/* ================================================================
   Section 5: Wiring & Initial Render
   ================================================================ */
btnPlay.addEventListener("click", play);
btnPause.addEventListener("click", pause);
btnReset.addEventListener("click", reset);

function intervalLabel(v) {
  if (v === 0) return "Steady State";
  if (v > 10000) return "Never";
  return v + " yr";
}

slInterval.addEventListener("input", function () {
  valInterval.textContent = intervalLabel(parseInt(slInterval.value));
  updateInfo();
});

slLocked.addEventListener("input", function () {
  var nLocked = parseInt(slLocked.value);
  var depth = (nLocked * 0.02).toFixed(0);
  valLocked.textContent = depth + " km";
  loadProfile(nLocked);
  reset();
});

slSpeed.addEventListener("input", function () {
  valSpeed.textContent = slSpeed.value + "x";
  STEPS_PER_FRAME = parseInt(slSpeed.value);
});

renderTopo(topoZ, rawZ);
renderUplift(false);
renderFault(false);
updateInfo();

})();
</script>
