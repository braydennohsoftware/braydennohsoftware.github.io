---
layout: default
title:  Earthquakes to Topography
---

<p>
<a href="index.html">Brayden Noh</a>
</p>

<h1>Earthquake Cycles to Topography</h1>

<p>
This simulator models topographic evolution over a planar reverse fault using the stream power equation.
Uplift is partitioned into steady <b>interseismic creeping</b> (deep fault) and sudden <b>coseismic rupture</b> (shallow fault) driven by the accumulated slip deficit. Adjust the cycle time to see how earthquake frequency and magnitude affect terrace formation.
</p>

<style>
  .controls {
    display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px;
    padding: 15px 20px; background: #f1f3f5; border-radius: 6px;
  }
  .button-group {
    display: flex; gap: 8px; margin-top: 5px;
  }
  .controls button {
    padding: 8px 16px; border: none; border-radius: 4px;
    background: #3498db; color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s;
  }
  .controls button:hover:not(:disabled) { background: #2980b9; }
  .controls button:disabled { background: #bdc3c7; cursor: not-allowed; }

  .sliders-container {
    display: flex; flex-direction: column; gap: 12px; flex: 1;
  }
  .slider-group { display: flex; align-items: center; gap: 12px; }
  .slider-group label { font-weight: 600; font-size: 14px; color: #2c3e50; min-width: 220px; }
  .slider-group input { flex: 1; cursor: pointer; }
  .slider-val { font-family: monospace; font-size: 14px; font-weight: bold; color: #e74c3c; width: 60px; text-align: right; }

  .info-bar {
    display: flex; gap: 25px; font-size: 14px; color: #555;
    margin-bottom: 15px; font-weight: 500; border-bottom: 1px solid #eee; padding-bottom: 10px;
  }
  .info-bar span strong { color: #2980b9; font-family: monospace; font-size: 15px; }
  .plot-title { font-size: 14px; font-weight: 600; color: #34495e; margin: 15px 0 5px 0; }
  #sim-container canvas { width: 100%; height: auto; display: block; }
</style>

<div class="controls">
  <div class="button-group">
    <button id="btn-play">Play</button>
    <button id="btn-pause" disabled>Pause</button>
    <button id="btn-reset">Reset</button>
  </div>
  <div class="sliders-container">
    <div class="slider-group">
      <label for="sl-interval">Earthquake Cycle (Slip Deficit):</label>
      <input id="sl-interval" type="range" min="0" max="10010" step="10" value="100">
      <div class="slider-val" id="val-interval">100 yr</div>
    </div>
    <div class="slider-group">
      <label for="sl-speed">Simulation Speed:</label>
      <input id="sl-speed" type="range" min="1" max="50" step="1" value="5">
      <div class="slider-val" id="val-speed">5x</div>
    </div>
  </div>
</div>

<div class="info-bar">
  <span>Time: <strong id="info-time">0</strong> yr</span>
  <span>Earthquakes: <strong id="info-eq">0</strong></span>
  <span>Next EQ in: <strong id="info-next">100</strong> yr</span>
  <span>Max Elevation: <strong id="info-maxz">0.0</strong> m</span>
</div>

<div id="sim-container">
  <div class="plot-title">Topography Evolution</div>
  <canvas id="canvas-topo"></canvas>

  <div class="plot-title">Fault Geometry &amp; Activity</div>
  <canvas id="canvas-fault"></canvas>
</div>

<script>
(function () {
"use strict";

/* ================================================================
   Section 0: Precomputed Data & Constants
   ================================================================ */
// Uplift arrays: 501 values (mm/yr), planar fault (0,0)-(10,-5), halfway transition
var UPLIFT_RED_RAW = [2.8961,0.6646,0.6692,0.6739,0.6786,0.6833,0.6881,0.6930,0.6979,0.7028,0.7078,0.7128,0.7179,0.7231,0.7282,0.7335,0.7388,0.7441,0.7495,0.7550,0.7605,0.7660,0.7717,0.7773,0.7831,0.7889,0.7947,0.8006,0.8066,0.8126,0.8187,0.8249,0.8311,0.8374,0.8437,0.8501,0.8566,0.8632,0.8698,0.8765,0.8832,0.8900,0.8969,0.9039,0.9109,0.9180,0.9252,0.9325,0.9398,0.9473,0.9547,0.9623,0.9700,0.9777,0.9855,0.9934,1.0014,1.0095,1.0177,1.0259,1.0343,1.0427,1.0512,1.0598,1.0685,1.0773,1.0862,1.0952,1.1043,1.1135,1.1228,1.1322,1.1417,1.1512,1.1609,1.1708,1.1807,1.1907,1.2008,1.2111,1.2214,1.2319,1.2425,1.2532,1.2640,1.2750,1.2860,1.2972,1.3085,1.3199,1.3315,1.3432,1.3550,1.3670,1.3790,1.3913,1.4036,1.4161,1.4287,1.4415,1.4544,1.4675,1.4807,1.4940,1.5075,1.5211,1.5349,1.5489,1.5630,1.5772,1.5916,1.6062,1.6209,1.6358,1.6509,1.6661,1.6815,1.6970,1.7127,1.7286,1.7447,1.7609,1.7773,1.7939,1.8107,1.8277,1.8448,1.8621,1.8796,1.8973,1.9152,1.9332,1.9515,1.9699,1.9886,2.0074,2.0264,2.0457,2.0651,2.0847,2.1045,2.1245,2.1447,2.1652,2.1858,2.2066,2.2277,2.2489,2.2703,2.2920,2.3139,2.3359,2.3582,2.3807,2.4034,2.4263,2.4494,2.4727,2.4962,2.5200,2.5439,2.5681,2.5924,2.6170,2.6418,2.6667,2.6919,2.7173,2.7429,2.7687,2.7946,2.8208,2.8472,2.8737,2.9005,2.9274,2.9545,2.9819,3.0093,3.0370,3.0648,3.0929,3.1210,3.1494,3.1779,3.2065,3.2353,3.2643,3.2934,3.3226,3.3520,3.3815,3.4111,3.4408,3.4707,3.5007,3.5307,3.5609,3.5911,3.6214,3.6518,3.6823,3.7128,3.7433,3.7740,3.8046,3.8353,3.8660,3.8967,3.9274,3.9581,3.9888,4.0195,4.0502,4.0808,4.1113,4.1418,4.1723,4.2026,4.2329,4.2631,4.2932,4.3231,4.3530,4.3827,4.4122,4.4416,4.4709,4.5000,4.5288,4.5575,4.5860,4.6143,4.6424,4.6702,4.6978,4.7252,4.7523,4.7791,4.8057,4.8319,4.8579,4.8836,4.9090,4.9341,4.9588,4.9832,5.0073,5.0310,5.0544,5.0774,5.1001,5.1224,5.1443,5.1658,5.1870,5.2078,5.2281,5.2481,5.2677,5.2869,5.3057,5.3240,5.3420,5.3595,5.3766,5.3933,5.4096,5.4255,5.4410,5.4560,5.4706,5.4848,5.4986,5.5119,5.5249,5.5374,5.5495,5.5612,5.5725,5.5834,5.5939,5.6040,5.6137,5.6230,5.6319,5.6404,5.6486,5.6563,5.6637,5.6708,5.6774,5.6837,5.6897,5.6953,5.7006,5.7055,5.7101,5.7143,5.7183,5.7219,5.7252,5.7283,5.7310,5.7334,5.7356,5.7374,5.7390,5.7403,5.7414,5.7422,5.7427,5.7431,5.7431,5.7430,5.7426,5.7420,5.7412,5.7401,5.7389,5.7375,5.7359,5.7341,5.7321,5.7299,5.7276,5.7251,5.7225,5.7197,5.7167,5.7136,5.7104,5.7070,5.7035,5.6999,5.6962,5.6924,5.6884,5.6843,5.6802,5.6759,5.6715,5.6671,5.6626,5.6579,5.6533,5.6485,5.6437,5.6388,5.6338,5.6288,5.6237,5.6185,5.6134,5.6081,5.6028,5.5975,5.5921,5.5867,5.5813,5.5758,5.5703,5.5648,5.5593,5.5537,5.5481,5.5425,5.5369,5.5312,5.5256,5.5199,5.5143,5.5086,5.5029,5.4972,5.4915,5.4858,5.4801,5.4745,5.4688,5.4631,5.4574,5.4518,5.4461,5.4405,5.4348,5.4292,5.4236,5.4180,5.4124,5.4069,5.4013,5.3958,5.3903,5.3848,5.3793,5.3738,5.3684,5.3630,5.3576,5.3522,5.3469,5.3415,5.3362,5.3310,5.3257,5.3205,5.3153,5.3101,5.3050,5.2998,5.2947,5.2897,5.2846,5.2796,5.2746,5.2697,5.2647,5.2598,5.2550,5.2501,5.2453,5.2405,5.2357,5.2310,5.2263,5.2216,5.2170,5.2124,5.2078,5.2032,5.1987,5.1942,5.1898,5.1853,5.1809,5.1765,5.1722,5.1679,5.1636,5.1593,5.1551,5.1509,5.1467,5.1425,5.1384,5.1343,5.1303,5.1262,5.1222,5.1183,5.1143,5.1104,5.1065,5.1026,5.0988,5.0950,5.0912,5.0874,5.0837,5.0800,5.0763,5.0727,5.0691,5.0655,5.0619,5.0584,5.0549,5.0514,5.0479,5.0445,5.0410,5.0377,5.0343,5.0310,5.0276,5.0243,5.0211,5.0178,5.0146,5.0114,5.0083,5.0051,5.0020,4.9989,4.9958,4.9928,4.9897,4.9867,4.9837,4.9808,4.9778,4.9749,4.9720,4.9691,4.9663,4.9634,4.9606,4.9578,4.9551,4.9523];
var UPLIFT_BLUE_RAW = [1.5761,3.8075,3.8029,3.7983,3.7936,3.7888,3.7840,3.7792,3.7743,3.7693,3.7643,3.7593,3.7542,3.7491,3.7439,3.7386,3.7334,3.7280,3.7226,3.7172,3.7117,3.7061,3.7005,3.6948,3.6891,3.6833,3.6774,3.6715,3.6655,3.6595,3.6534,3.6473,3.6410,3.6348,3.6284,3.6220,3.6155,3.6090,3.6024,3.5957,3.5889,3.5821,3.5752,3.5682,3.5612,3.5541,3.5469,3.5396,3.5323,3.5249,3.5174,3.5098,3.5022,3.4944,3.4866,3.4787,3.4707,3.4626,3.4545,3.4462,3.4379,3.4294,3.4209,3.4123,3.4036,3.3948,3.3859,3.3769,3.3678,3.3587,3.3494,3.3400,3.3305,3.3209,3.3112,3.3014,3.2915,3.2814,3.2713,3.2611,3.2507,3.2402,3.2296,3.2189,3.2081,3.1972,3.1861,3.1749,3.1636,3.1522,3.1406,3.1289,3.1171,3.1052,3.0931,3.0809,3.0685,3.0560,3.0434,3.0306,3.0177,3.0047,2.9915,2.9781,2.9646,2.9510,2.9372,2.9233,2.9092,2.8949,2.8805,2.8660,2.8512,2.8363,2.8213,2.8061,2.7907,2.7751,2.7594,2.7435,2.7274,2.7112,2.6948,2.6782,2.6614,2.6445,2.6273,2.6100,2.5925,2.5748,2.5570,2.5389,2.5206,2.5022,2.4836,2.4647,2.4457,2.4265,2.4071,2.3874,2.3676,2.3476,2.3274,2.3070,2.2863,2.2655,2.2445,2.2232,2.2018,2.1801,2.1583,2.1362,2.1139,2.0914,2.0688,2.0459,2.0227,1.9994,1.9759,1.9522,1.9282,1.9041,1.8797,1.8551,1.8304,1.8054,1.7802,1.7548,1.7293,1.7035,1.6775,1.6513,1.6250,1.5984,1.5717,1.5447,1.5176,1.4903,1.4628,1.4351,1.4073,1.3793,1.3511,1.3228,1.2943,1.2656,1.2368,1.2078,1.1787,1.1495,1.1201,1.0906,1.0610,1.0313,1.0014,0.9715,0.9414,0.9113,0.8810,0.8507,0.8203,0.7899,0.7594,0.7288,0.6982,0.6675,0.6369,0.6062,0.5754,0.5447,0.5140,0.4833,0.4526,0.4220,0.3914,0.3608,0.3303,0.2999,0.2695,0.2392,0.2091,0.1790,0.1490,0.1192,0.0895,0.0599,0.0305,0.0013,-0.0278,-0.0567,-0.0854,-0.1139,-0.1422,-0.1703,-0.1981,-0.2257,-0.2531,-0.2802,-0.3070,-0.3335,-0.3598,-0.3858,-0.4115,-0.4369,-0.4619,-0.4867,-0.5111,-0.5351,-0.5589,-0.5823,-0.6053,-0.6279,-0.6502,-0.6722,-0.6937,-0.7149,-0.7356,-0.7560,-0.7760,-0.7956,-0.8147,-0.8335,-0.8519,-0.8698,-0.8874,-0.9045,-0.9212,-0.9375,-0.9534,-0.9688,-0.9839,-0.9985,-1.0127,-1.0264,-1.0398,-1.0527,-1.0653,-1.0774,-1.0891,-1.1004,-1.1113,-1.1218,-1.1319,-1.1416,-1.1509,-1.1598,-1.1683,-1.1764,-1.1842,-1.1916,-1.1986,-1.2053,-1.2116,-1.2176,-1.2232,-1.2284,-1.2334,-1.2379,-1.2422,-1.2462,-1.2498,-1.2531,-1.2561,-1.2588,-1.2613,-1.2634,-1.2653,-1.2669,-1.2682,-1.2692,-1.2701,-1.2706,-1.2709,-1.2710,-1.2708,-1.2705,-1.2698,-1.2690,-1.2680,-1.2668,-1.2653,-1.2637,-1.2619,-1.2599,-1.2578,-1.2555,-1.2530,-1.2503,-1.2475,-1.2446,-1.2415,-1.2383,-1.2349,-1.2314,-1.2278,-1.2241,-1.2202,-1.2163,-1.2122,-1.2080,-1.2038,-1.1994,-1.1950,-1.1904,-1.1858,-1.1811,-1.1764,-1.1715,-1.1666,-1.1617,-1.1566,-1.1515,-1.1464,-1.1412,-1.1360,-1.1307,-1.1254,-1.1200,-1.1146,-1.1092,-1.1037,-1.0982,-1.0927,-1.0871,-1.0816,-1.0760,-1.0704,-1.0647,-1.0591,-1.0535,-1.0478,-1.0421,-1.0364,-1.0308,-1.0251,-1.0194,-1.0137,-1.0080,-1.0023,-0.9966,-0.9910,-0.9853,-0.9796,-0.9740,-0.9683,-0.9627,-0.9571,-0.9515,-0.9459,-0.9403,-0.9347,-0.9292,-0.9236,-0.9181,-0.9126,-0.9072,-0.9017,-0.8963,-0.8908,-0.8855,-0.8801,-0.8747,-0.8694,-0.8641,-0.8588,-0.8536,-0.8484,-0.8432,-0.8380,-0.8328,-0.8277,-0.8226,-0.8175,-0.8125,-0.8075,-0.8025,-0.7975,-0.7926,-0.7877,-0.7828,-0.7780,-0.7732,-0.7684,-0.7636,-0.7589,-0.7542,-0.7495,-0.7449,-0.7403,-0.7357,-0.7311,-0.7266,-0.7221,-0.7176,-0.7132,-0.7088,-0.7044,-0.7000,-0.6957,-0.6914,-0.6872,-0.6829,-0.6787,-0.6746,-0.6704,-0.6663,-0.6622,-0.6581,-0.6541,-0.6501,-0.6461,-0.6422,-0.6383,-0.6344,-0.6305,-0.6267,-0.6228,-0.6191,-0.6153,-0.6116,-0.6079,-0.6042,-0.6006,-0.5969,-0.5933,-0.5898,-0.5862,-0.5827,-0.5792,-0.5758,-0.5723,-0.5689,-0.5655,-0.5622,-0.5588,-0.5555,-0.5522,-0.5489,-0.5457,-0.5425,-0.5393,-0.5361,-0.5330,-0.5299,-0.5268,-0.5237,-0.5206,-0.5176,-0.5146,-0.5116,-0.5086,-0.5057,-0.5028,-0.4999,-0.4970,-0.4941,-0.4913,-0.4885,-0.4857,-0.4829,-0.4802];

// Planar fault geometry: (0,0) to (10,-5), 100 nodes
var FAULT_X = [0.0000,0.1010,0.2020,0.3030,0.4040,0.5051,0.6061,0.7071,0.8081,0.9091,1.0101,1.1111,1.2121,1.3131,1.4141,1.5152,1.6162,1.7172,1.8182,1.9192,2.0202,2.1212,2.2222,2.3232,2.4242,2.5253,2.6263,2.7273,2.8283,2.9293,3.0303,3.1313,3.2323,3.3333,3.4343,3.5354,3.6364,3.7374,3.8384,3.9394,4.0404,4.1414,4.2424,4.3434,4.4444,4.5455,4.6465,4.7475,4.8485,4.9495,5.0505,5.1515,5.2525,5.3535,5.4545,5.5556,5.6566,5.7576,5.8586,5.9596,6.0606,6.1616,6.2626,6.3636,6.4646,6.5657,6.6667,6.7677,6.8687,6.9697,7.0707,7.1717,7.2727,7.3737,7.4747,7.5758,7.6768,7.7778,7.8788,7.9798,8.0808,8.1818,8.2828,8.3838,8.4848,8.5859,8.6869,8.7879,8.8889,8.9899,9.0909,9.1919,9.2929,9.3939,9.4949,9.5960,9.6970,9.7980,9.8990,10.0000];
var FAULT_Z = [-0.0000,-0.0505,-0.1010,-0.1515,-0.2020,-0.2525,-0.3030,-0.3535,-0.4040,-0.4545,-0.5051,-0.5556,-0.6061,-0.6566,-0.7071,-0.7576,-0.8081,-0.8586,-0.9091,-0.9596,-1.0101,-1.0606,-1.1111,-1.1616,-1.2121,-1.2626,-1.3131,-1.3636,-1.4141,-1.4646,-1.5152,-1.5657,-1.6162,-1.6667,-1.7172,-1.7677,-1.8182,-1.8687,-1.9192,-1.9697,-2.0202,-2.0707,-2.1212,-2.1717,-2.2222,-2.2727,-2.3232,-2.3737,-2.4242,-2.4747,-2.5253,-2.5758,-2.6263,-2.6768,-2.7273,-2.7778,-2.8283,-2.8788,-2.9293,-2.9798,-3.0303,-3.0808,-3.1313,-3.1818,-3.2323,-3.2828,-3.3333,-3.3838,-3.4343,-3.4848,-3.5354,-3.5859,-3.6364,-3.6869,-3.7374,-3.7879,-3.8384,-3.8889,-3.9394,-3.9899,-4.0404,-4.0909,-4.1414,-4.1919,-4.2424,-4.2929,-4.3434,-4.3939,-4.4444,-4.4949,-4.5455,-4.5960,-4.6465,-4.6970,-4.7475,-4.7980,-4.8485,-4.8990,-4.9495,-5.0000];
var FAULT_ACTIVE_CUT = 50;

var NX = 501;
var X_END = 10.0; // km
var DX = X_END / (NX - 1); // 0.02 km
var K = 1e-4;
var M_EXP = 0.5;
var N_EXP = 1.0;
var H_EXP = 1.67;
var DT = 1; // 1 year per step
var STEPS_PER_FRAME = 5; // Default speed multiplier

// Build dense uplift arrays directly (already at grid resolution, mm/yr -> km/yr)
var upliftRed = new Float64Array(NX);
var upliftBlue = new Float64Array(NX);
var xGrid = new Float64Array(NX);
var DA = new Float64Array(NX);

for (var i = 0; i < NX; i++) {
  xGrid[i] = i * DX;
  upliftRed[i]  = UPLIFT_RED_RAW[i] * 1e-6;
  upliftBlue[i] = UPLIFT_BLUE_RAW[i] * 1e-6;
  var Lx = X_END - xGrid[i];
  DA[i] = Math.max(Math.pow(Math.max(Lx, 0), H_EXP), 1.0);
}

/* ================================================================
   Section 1: DOM Refs & Canvas Setup
   ================================================================ */
var canvasTopo  = document.getElementById("canvas-topo");
var canvasFault = document.getElementById("canvas-fault");
var DPR = window.devicePixelRatio || 1;

function initCanvas(canvas, w, h) {
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    canvas.width = w * DPR;
    canvas.height = h * DPR;
    var ctx = canvas.getContext("2d");
    ctx.scale(DPR, DPR);
    return ctx;
}

var ctxTopo = initCanvas(canvasTopo, 840, 260);
var ctxFault = initCanvas(canvasFault, 840, 200);

var btnPlay  = document.getElementById("btn-play");
var btnPause = document.getElementById("btn-pause");
var btnReset = document.getElementById("btn-reset");
var slInterval = document.getElementById("sl-interval");
var valInterval = document.getElementById("val-interval");
var slSpeed = document.getElementById("sl-speed");
var valSpeed = document.getElementById("val-speed");
var infoTime = document.getElementById("info-time");
var infoMaxZ = document.getElementById("info-maxz");
var infoEq   = document.getElementById("info-eq");
var infoNext = document.getElementById("info-next");

/* ================================================================
   Section 2: TVD Solver & Utilities
   ================================================================ */

function getNiceTicks(min, max, numTicks) {
    var range = max - min;
    if (range === 0) return [min];
    var step = Math.pow(10, Math.floor(Math.log10(range / numTicks)));
    var err = numTicks / (range / step);
    if (err <= .15) step *= 10;
    else if (err <= .35) step *= 5;
    else if (err <= .75) step *= 2;
    var ticks = [];
    var start = Math.ceil(min / step) * step;
    for (var val = start; val <= max + 1e-9; val += step) {
        ticks.push(parseFloat(val.toPrecision(10)));
    }
    return ticks;
}

function fillDepressions(z) {
  // Forces elevation to be monotonically increasing from left to right
  var max_val = z[0];
  for (var i = 1; i < z.length; i++) {
    if (z[i] < max_val) {
        z[i] = max_val;
    } else {
        max_val = z[i];
    }
  }
}

function tvdErosionStep(z, dx, dtMacro, Ke, m, n, DA, cfl) {
    var nx = z.length;
    var a = new Float64Array(nx);

    // Wave speed a = K * A^m * (dz/dx)^{n-1}
    // Wave travels left to right (a > 0)
    for (var i = 0; i < nx; i++) {
        var slope = (i < nx - 1) ? ((z[i+1] - z[i]) / dx) : ((z[i] - z[i-1]) / dx);
        if (slope < 0) slope = 0;

        var c = Ke * Math.pow(Math.max(DA[i], 1e-12), m);
        if (n !== 1.0) c = c * Math.pow(slope, n - 1.0);
        a[i] = c;
    }

    var a_max = 0;
    for (var i = 0; i < nx; i++) { if (a[i] > a_max) a_max = a[i]; }

    var dt_sub = dtMacro;
    if (a_max > 0) {
        var dt_allow = cfl * dx / a_max;
        if (dt_allow < dt_sub) dt_sub = dt_allow;
    }

    var steps = Math.ceil(dtMacro / dt_sub);
    dt_sub = dtMacro / steps;

    var z_new = new Float64Array(nx);
    var r = new Float64Array(nx);
    var phi = new Float64Array(nx);

    for (var s = 0; s < steps; s++) {
        for (var i = 0; i < nx; i++) {
            var dz_local = (i < nx - 1) ? (z[i+1] - z[i]) : 0;
            var dz_up = (i > 0) ? (z[i] - z[i-1]) : 0;
            if (Math.abs(dz_local) > 1e-12) r[i] = dz_up / dz_local;
            else r[i] = 1.0;
        }

        for (var i = 0; i < nx; i++) {
            phi[i] = (r[i] + Math.abs(r[i])) / (1.0 + Math.abs(r[i]));
        }

        for (var i = 1; i < nx - 1; i++) {
            var a_val = a[i];
            var z_val = z[i];
            var zr_val = z[i+1];
            var zl_val = z[i-1];

            var phi_R = phi[i];     // limiter at i+1/2
            var phi_L = phi[i-1];   // limiter at i-1/2

            var Fr_low = a_val * z_val;
            var Fr_high = 0.5 * a_val * (z_val + zr_val) - 0.5 * a_val * a_val * (dt_sub / dx) * (zr_val - z_val);
            var Fr = Fr_low + phi_R * (Fr_high - Fr_low);

            var Fl_low = a_val * zl_val;
            var Fl_high = 0.5 * a_val * (zl_val + z_val) - 0.5 * a_val * a_val * (dt_sub / dx) * (z_val - zl_val);
            var Fl = Fl_low + phi_L * (Fl_high - Fl_low);

            z_new[i] = z[i] - (dt_sub / dx) * (Fr - Fl);
        }
        z_new[0] = 0.0;
        z_new[nx-1] = z_new[nx-2]; // Divide mirrors neighbor to prevent spike

        for (var i = 0; i < nx; i++) z[i] = Math.max(0, z_new[i]);
    }
    return z;
}

/* ================================================================
   Section 3: Plot Rendering (Matplotlib-style)
   ================================================================ */
var PAD = { left: 60, right: 20, top: 20, bottom: 40 };

function makePlotTransform(cw, ch, xMin, xMax, yMin, yMax) {
  var pw = cw - PAD.left - PAD.right;
  var ph = ch - PAD.top - PAD.bottom;
  return {
    xMin: xMin, xMax: xMax, yMin: yMin, yMax: yMax, pw: pw, ph: ph,
    toCanvasX: function (x) { return PAD.left + (x - xMin) / (xMax - xMin) * pw; },
    toCanvasY: function (y) { return PAD.top + (1 - (y - yMin) / (yMax - yMin)) * ph; }
  };
}

function drawAxes(ctx, t, xLabel, yLabel, xTicks, yTicks, yTickLabels) {
    if (!yTickLabels) yTickLabels = yTicks;

    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1.5;
    ctx.beginPath();

    var x0 = t.toCanvasX(t.xMin);
    var x1 = t.toCanvasX(t.xMax);
    var y0 = t.toCanvasY(t.yMin);
    var y1 = t.toCanvasY(t.yMax);

    ctx.moveTo(x0, y0); ctx.lineTo(x1, y0); // X axis
    ctx.moveTo(x0, y0); ctx.lineTo(x0, y1); // Y axis
    ctx.stroke();

    ctx.fillStyle = "#333";
    ctx.font = "12px sans-serif";

    // X ticks
    ctx.textAlign = "center";
    ctx.textBaseline = "top";
    for(var i=0; i<xTicks.length; i++) {
        var x = xTicks[i];
        var cx = t.toCanvasX(x);
        ctx.beginPath(); ctx.moveTo(cx, y0); ctx.lineTo(cx, y0+5); ctx.stroke();
        ctx.fillText(x, cx, y0+8);
    }
    ctx.fillText(xLabel, (x0+x1)/2, y0 + 25);

    // Y ticks
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    for(var i=0; i<yTicks.length; i++) {
        var y = yTicks[i];
        var lbl = yTickLabels[i];
        var cy = t.toCanvasY(y);
        ctx.beginPath(); ctx.moveTo(x0, cy); ctx.lineTo(x0-5, cy); ctx.stroke();
        ctx.fillText(lbl, x0-8, cy);
    }

    ctx.save();
    ctx.translate(x0 - 45, (y0+y1)/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign = "center";
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();
}

function renderTopo(topoZ, rawZ) {
  var cw = canvasTopo.width / DPR, ch = canvasTopo.height / DPR;

  var zMax = 0;
  for (var i = 0; i < NX; i++) { if (topoZ[i] > zMax) zMax = topoZ[i]; }
  zMax = Math.max(zMax, 0.005) * 1.2; // Min 6 meters dynamic scale
  var zMin = 0;

  var t = makePlotTransform(cw, ch, 0, X_END, zMin, zMax);
  ctxTopo.clearRect(0, 0, cw, ch);

  var yTicksKm = getNiceTicks(zMin, zMax, 4);
  var yTicksM = yTicksKm.map(function(y) { return (y * 1000).toFixed(1); });

  drawAxes(ctxTopo, t, "Distance from MFT (km)", "Elevation (m)", [0, 2, 4, 6, 8, 10], yTicksKm, yTicksM);

  // Terrain Fill (Gray)
  ctxTopo.fillStyle = "rgba(180, 180, 180, 0.5)";
  ctxTopo.beginPath();
  ctxTopo.moveTo(t.toCanvasX(xGrid[0]), t.toCanvasY(0));
  for (var i = 0; i < NX; i++) {
    ctxTopo.lineTo(t.toCanvasX(xGrid[i]), t.toCanvasY(topoZ[i]));
  }
  ctxTopo.lineTo(t.toCanvasX(xGrid[NX - 1]), t.toCanvasY(0));
  ctxTopo.closePath();
  ctxTopo.fill();

  // Lake fill overlay (blue fill to indicate fill areas)
  if (rawZ) {
    ctxTopo.fillStyle = "rgba(41, 128, 185, 0.6)";
    ctxTopo.beginPath();
    ctxTopo.moveTo(t.toCanvasX(xGrid[0]), t.toCanvasY(topoZ[0]));
    for (var i = 1; i < NX; i++) {
      ctxTopo.lineTo(t.toCanvasX(xGrid[i]), t.toCanvasY(topoZ[i]));
    }
    for (var i = NX - 1; i >= 0; i--) {
      ctxTopo.lineTo(t.toCanvasX(xGrid[i]), t.toCanvasY(rawZ[i]));
    }
    ctxTopo.closePath();
    ctxTopo.fill();
  }

  // Topographic Line (Black)
  ctxTopo.strokeStyle = "#000000";
  ctxTopo.lineWidth = 2;
  ctxTopo.beginPath();
  for (var i = 0; i < NX; i++) {
    var px = t.toCanvasX(xGrid[i]);
    var py = t.toCanvasY(topoZ[i]);
    if (i === 0) ctxTopo.moveTo(px, py); else ctxTopo.lineTo(px, py);
  }
  ctxTopo.stroke();
}

function renderFault(eqFlash) {
  var cw = canvasFault.width / DPR, ch = canvasFault.height / DPR;
  var t = makePlotTransform(cw, ch, 0, 10, -5.5, 0.5);

  ctxFault.clearRect(0, 0, cw, ch);

  var yTicks = [-5, -4, -3, -2, -1, 0];
  drawAxes(ctxFault, t, "Distance from MFT (km)", "Depth (km)", [0, 2, 4, 6, 8, 10], yTicks);

  var colorActive = "#e74c3c", colorInactive = "#95a5a6";
  var widthActive = 3.5, widthInactive = 1.5;

  var eqInterval = getInterval();
  var allActive = (eqInterval === 0); // Steady state: entire fault creeping

  var colorShallow = allActive ? colorActive : (eqFlash ? colorActive : colorInactive);
  var widthShallow = allActive ? widthActive : (eqFlash ? widthActive : widthInactive);

  var colorDeep = allActive ? colorActive : ((!eqFlash) ? colorActive : colorInactive);
  var widthDeep = allActive ? widthActive : ((!eqFlash) ? widthActive : widthInactive);

  // Draw Deep (Creeping)
  ctxFault.strokeStyle = colorDeep;
  ctxFault.lineWidth = widthDeep;
  ctxFault.beginPath();
  for (var i = FAULT_ACTIVE_CUT; i < FAULT_X.length; i++) {
    var cx = t.toCanvasX(FAULT_X[i]);
    var cy = t.toCanvasY(FAULT_Z[i]);
    if (i === FAULT_ACTIVE_CUT) ctxFault.moveTo(cx, cy);
    else ctxFault.lineTo(cx, cy);
  }
  ctxFault.stroke();

  // Draw Shallow (Locked)
  ctxFault.strokeStyle = colorShallow;
  ctxFault.lineWidth = widthShallow;
  ctxFault.beginPath();
  for (var i = 0; i <= FAULT_ACTIVE_CUT; i++) {
    var cx = t.toCanvasX(FAULT_X[i]);
    var cy = t.toCanvasY(FAULT_Z[i]);
    if (i === 0) ctxFault.moveTo(cx, cy);
    else ctxFault.lineTo(cx, cy);
  }
  ctxFault.stroke();

}

/* ================================================================
   Section 4: Simulation State & Loop
   ================================================================ */
var topoZ = new Float64Array(NX);
var rawZ  = new Float64Array(NX);
var simTime = 0;
var eqCount = 0;
var timeSinceLastEq = 0;
var eqFlashFrames = 0;
var playing = false;
var animFrameId = null;

function getInterval() { return parseInt(slInterval.value); }

function doStep() {
  var eqInterval = getInterval();

  if (eqInterval === 0) {
    // STEADY STATE: apply full structural rate (red + blue) every step
    for (var i = 1; i < NX; i++) {
      topoZ[i] += (upliftRed[i] + upliftBlue[i]) * DT;
    }
  } else if (eqInterval > 10000) {
    // NEVER: only interseismic, coseismic never releases
    for (var i = 1; i < NX; i++) {
      topoZ[i] += upliftRed[i] * DT;
    }
  } else {
    // Normal earthquake cycle
    // 1. Interseismic Uplift
    for (var i = 1; i < NX; i++) {
      topoZ[i] += upliftRed[i] * DT;
    }
    // 2. Check Earthquake Trigger
    timeSinceLastEq += DT;
    if (timeSinceLastEq >= eqInterval) {
      for (var i = 1; i < NX; i++) {
        topoZ[i] += upliftBlue[i] * eqInterval;
      }
      timeSinceLastEq = 0;
      eqCount++;
      eqFlashFrames = 15;
    }
  }

  // 3. Fluvial Erosion (TVD Step)
  topoZ = tvdErosionStep(topoZ, DX, DT, K, M_EXP, N_EXP, DA, 0.9);

  // 4. Save Raw Z and Fill Depressions
  for (var i = 0; i < NX; i++) { rawZ[i] = topoZ[i]; }
  fillDepressions(topoZ);

  simTime += DT;
}

function updateInfo() {
  var eqInterval = getInterval();
  infoTime.textContent = simTime;
  var maxZ = 0;
  for (var i = 0; i < NX; i++) if (topoZ[i] > maxZ) maxZ = topoZ[i];
  infoMaxZ.textContent = (maxZ * 1000).toFixed(2);
  infoEq.textContent = eqCount;
  if (eqInterval === 0) {
    infoNext.textContent = "N/A";
  } else if (eqInterval > 10000) {
    infoNext.textContent = "Never";
  } else {
    infoNext.textContent = Math.max(0, eqInterval - timeSinceLastEq);
  }
}

function animate() {
  if (!playing) return;

  for (var s = 0; s < STEPS_PER_FRAME; s++) {
    doStep();
  }

  var flash = eqFlashFrames > 0;
  if (eqFlashFrames > 0) eqFlashFrames--;

  renderTopo(topoZ, rawZ);
  renderFault(flash);
  updateInfo();

  animFrameId = requestAnimationFrame(animate);
}

function play() {
  playing = true;
  btnPlay.disabled = true;
  btnPause.disabled = false;
  animFrameId = requestAnimationFrame(animate);
}

function pause() {
  playing = false;
  btnPlay.disabled = false;
  btnPause.disabled = true;
  if (animFrameId) cancelAnimationFrame(animFrameId);
}

function reset() {
  pause();
  simTime = 0;
  eqCount = 0;
  timeSinceLastEq = 0;
  eqFlashFrames = 0;
  topoZ = new Float64Array(NX);
  rawZ  = new Float64Array(NX);
  renderTopo(topoZ, rawZ);
  renderFault(false);
  updateInfo();
}

/* ================================================================
   Section 5: Wiring & Initial Render
   ================================================================ */
btnPlay.addEventListener("click", play);
btnPause.addEventListener("click", pause);
btnReset.addEventListener("click", reset);

function intervalLabel(v) {
  if (v === 0) return "Steady State";
  if (v > 10000) return "Never";
  return v + " yr";
}

slInterval.addEventListener("input", function () {
  valInterval.textContent = intervalLabel(parseInt(slInterval.value));
  updateInfo();
});

slSpeed.addEventListener("input", function () {
  valSpeed.textContent = slSpeed.value + "x";
  STEPS_PER_FRAME = parseInt(slSpeed.value);
});

renderTopo(topoZ, rawZ);
renderFault(false);
updateInfo();

})();
</script>
